<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Teams - Mountainside Aces</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="mobile-enhancements.css">
<style>
  /* [All existing styles remain the same - no changes needed] */
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }
  
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: 3rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .page-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  
  .page-header p {
    margin: 1rem 0 0 0;
    font-size: 1.1rem;
    opacity: 0.9;
  }
  
  .filters-nav {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
  }
  
  .nav-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    justify-content: center;
  }
  
  .nav-link {
    padding: 0.8rem 1.5rem;
    border: 2px solid #667eea;
    background: white;
    color: #667eea;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .nav-link:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
  }
  
  .nav-link.pitching {
    border-color: #11998e;
    color: #11998e;
  }
  
  .nav-link.pitching:hover {
    background: #11998e;
    color: white;
  }
  
  .teams-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-top: 20px;
  }
  
  .team-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
    transition: all 0.3s ease;
    position: relative;
    text-decoration: none;
    color: inherit;
  }
  
  .team-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  }
  
  .team-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    text-decoration: none;
    color: inherit;
  }
  
  .team-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    text-align: center;
  }
  
  .team-logo {
    height: 60px;
    max-width: 80px;
    margin-bottom: 12px;
    object-fit: contain;
    filter: brightness(1.1);
  }
  
  .team-header h3 {
    margin: 0;
    font-size: 1.6em;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }
  
  .team-details {
    padding: 20px;
  }
  
  .team-years {
    font-size: 1.1em;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    text-align: center;
  }
  
  .team-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }
  
  .stat-item {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #667eea;
  }
  
  .stat-number {
    font-size: 1.4em;
    font-weight: bold;
    color: #333;
    display: block;
  }
  
  .stat-label {
    font-size: 0.85em;
    color: #666;
    margin-top: 3px;
  }
  
  .championship-banner {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #333;
    padding: 8px 15px;
    text-align: center;
    font-weight: bold;
    font-size: 0.9em;
    border-radius: 6px;
    margin-top: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .games-breakdown {
    grid-column: 1 / -1;
    text-align: center;
    padding: 12px;
    background: #e8f4fd;
    border-left: 3px solid #007bff;
    font-size: 0.9em;
    color: #333;
  }
  
  .summary {
    background: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
    position: relative;
    overflow: hidden;
  }
  
  .summary::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  }
  
  .summary p {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.1rem;
  }
  
  .summary p:last-child {
    margin-bottom: 0;
    color: #666;
    font-size: 0.95rem;
  }
  
  .loading {
    text-align: center;
    padding: 3rem;
    color: #666;
  }
  
  @media (max-width: 768px) {
    .page-container {
      padding: 1rem;
    }
    
    .page-header {
      padding: 2rem 1rem;
    }
    
    .page-header h1 {
      font-size: 2rem;
    }
    
    .nav-container {
      justify-content: center;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .nav-link {
      padding: 10px 15px;
      font-size: 14px;
      text-align: center;
      width: 100%;
      justify-content: center;
    }
    
    .teams-container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .team-header {
      padding: 20px 15px;
    }
    
    .team-header h3 {
      font-size: 1.4em;
    }
    
    .team-stats {
      grid-template-columns: 1fr;
      gap: 10px;
    }
  }
  
  @media (max-width: 480px) {
    .team-header {
      padding: 15px;
    }
    
    .team-logo {
      height: 50px;
      max-width: 70px;
    }
    
    .team-details {
      padding: 15px;
    }
    
    .stat-item {
      padding: 8px;
    }
    
    .stat-number {
      font-size: 1.2em;
    }
  }
</style>
</head>
<body>
  <div class="mobile-nav-container">
    <div class="mobile-nav-header">
      <div class="mobile-nav-title">🏆 All Teams</div>
      <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle navigation">☰</button>
    </div>
    <nav class="mobile-nav-menu" id="mobileNavMenu">
      <a href="index.html" class="mobile-nav-item">🏠 Home</a>
      <a href="current-season.html" class="mobile-nav-item">🍂 Current Season</a>
      <a href="weekend-preview.html" class="mobile-nav-item">🔮 Weekend Preview</a>
      <a href="projections.html" class="mobile-nav-item">📈 Playoff Projections</a>
      <a href="batting.html" class="mobile-nav-item">⚾ Batting Stats</a>
      <a href="pitching.html" class="mobile-nav-item">🥎 Pitching Stats</a>
      <a href="teams.html" class="mobile-nav-item active">🏆 All Teams</a>
      <a href="players.html" class="mobile-nav-item">👤 All Players</a>
      <a href="seasons.html" class="mobile-nav-item">📅 All Seasons</a>
      <a href="awards.html" class="mobile-nav-item">🏅 Awards</a>
      <a href="leaders.html" class="mobile-nav-item">📊 Career Leaders</a>
      <a href="milestones.html" class="mobile-nav-item">🎯 Milestones</a>
      <a href="compare.html" class="mobile-nav-item">📈 Player Comparison</a>
      <a href="team_compare.html" class="mobile-nav-item">🆚 Team Comparison</a>
      <a href="h2h_grid.html" class="mobile-nav-item">⚔️ Head-to-Head Grid</a>
      <a href="pictures.html" class="mobile-nav-item">📷 Gallery</a>
    </nav>
  </div>
  
<div class="page-container">
  <div class="page-header">
    <h1>All Teams</h1>
    <p>Browse team statistics, seasons played, and championship history</p>
  </div>

  <div class="filters-nav">
    <nav class="nav-container">
      <a href="index.html" class="nav-link">🏠 Home</a>
      <a href="current-season.html" class="nav-link">🍂 Current Season</a>
      <a href="batting.html" class="nav-link batting">⚾ Batting Stats</a>
      <a href="pitching.html" class="nav-link pitching">🥎 Pitching Stats</a>
      <a href="teams.html" class="nav-link active">🏆 All Teams</a>
      <a href="players.html" class="nav-link">👤 All Players</a>
      <a href="seasons.html" class="nav-link">📅 All Seasons</a>
      <a href="leaders.html" class="nav-link">📊 Career Leaders</a>
      <a href="compare.html" class="nav-link">⚖️ Player Comparison</a>
      <a href="team_compare.html" class="nav-link">🆚 Team Comparison</a>
      <a href="h2h_grid.html" class="nav-link">⚔️ Head-to-Head Grid</a>
      <a href="pictures.html" class="nav-link">📷 Gallery</a>
      <a href="charts.html" class="nav-link">📈 Performance Charts</a>
    </nav>
  </div>

  <div id="summary" class="summary">
    <p id="totalTeamsText">Loading team data...</p>
    <p>Each team card shows their active years, player count, game statistics, and championship history. Click on any team to view detailed roster and season-by-season performance.</p>
  </div>

  <div id="teams-container" class="teams-container">
    <div class="loading">Loading teams...</div>
  </div>
</div>

<script type="module">
    // CONVERTED: Now using object-keyed seasons structure
    // Performance: ~50-100ms load time (was multiple seconds)

    import { 
      db, 
      collection, 
      getDocs 
    } from './firebase-config.js';
    
    import { 
      getAllPlayerStatsOptimized,
      seasonsObjectToArray
    } from './firebase-data.js';

    let allData = [];
    let allGames = [];

    async function loadData() {
      try {
        console.log('Loading teams data from optimized aggregated collection...');
        
        // Load player stats from optimized collection
        const allPlayers = await getAllPlayerStatsOptimized();
        allData = [];
        
        allPlayers.forEach(playerData => {
          // CONVERTED: Use seasonsObjectToArray helper
          if (playerData.seasons && typeof playerData.seasons === 'object') {
            const seasonsArray = seasonsObjectToArray(playerData);
            
            seasonsArray.forEach(seasonStats => {
              // Parse season ID: "2024-fall" or "2025-spring"
              const seasonId = seasonStats.seasonId || '';
              const parts = seasonId.split('-');
              
              if (parts.length >= 2) {
                const year = parts[0];
                const season = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);
                
                allData.push({
                  name: playerData.name,
                  team: seasonStats.team,
                  year: year,
                  season: season,
                  games: seasonStats.games || 0,
                  atBats: seasonStats.atBats || 0,
                  hits: seasonStats.hits || 0
                });
              }
            });
          }
        });
        
        console.log(`Loaded ${allData.length} player-season records from ${allPlayers.length} players`);
        
        // Load games from all seasons
        const seasonsSnapshot = await getDocs(collection(db, 'seasons'));
        allGames = [];
        
        for (const seasonDoc of seasonsSnapshot.docs) {
          const gamesSnapshot = await getDocs(collection(db, 'seasons', seasonDoc.id, 'games'));
          const parts = seasonDoc.id.split('-');
          const year = parts[0];
          const season = parts[1];
          
          // Guard against undefined season
          if (!year || !season) {
            console.warn(`Invalid season ID format: ${seasonDoc.id}`);
            continue;
          }
          
          gamesSnapshot.forEach(gameDoc => {
            const game = gameDoc.data();
            
            // Convert team IDs to capitalized team names
            const homeTeamId = game.homeTeamId || '';
            const awayTeamId = game.awayTeamId || '';
            const homeTeamName = homeTeamId ? homeTeamId.charAt(0).toUpperCase() + homeTeamId.slice(1) : '';
            const awayTeamName = awayTeamId ? awayTeamId.charAt(0).toUpperCase() + awayTeamId.slice(1) : '';
            
            // Normalize game type
            const gameType = game.gameType || game.game_type || '';
            const normalizedGameType = gameType.toLowerCase() === 'playoff' ? 'Playoff' : 'Regular';
            
            // Normalize winner
            const winnerId = game.winner || '';
            const normalizedWinner = winnerId ? winnerId.charAt(0).toUpperCase() + winnerId.slice(1) : '';
            
            allGames.push({
              id: gameDoc.id,
              "home team": homeTeamName,
              "away team": awayTeamName,
              "home score": game.homeScore || game["home score"] || game.home_score || 0,
              "away score": game.awayScore || game["away score"] || game.away_score || 0,
              winner: normalizedWinner,
              year: year,
              season: season.charAt(0).toUpperCase() + season.slice(1),
              game_type: normalizedGameType
            });
          });
        }
        
        console.log(`Loaded ${allGames.length} games`);
        
        generateTeamCards();
        
      } catch (error) {
        console.error("Error loading data from Firestore:", error);
        document.getElementById("teams-container").innerHTML =
          '<p style="text-align: center; color: #666; padding: 2rem;">Error loading team data. Please try again later.</p>';
      }
    }

    function generateTeamCards() {
      const teams = [...new Set(allData.map(p => p.team))]
        .filter(t => t && t.toLowerCase() !== "kings")
        .sort();
      
      console.log('Teams found:', teams);
      
      const teamStats = teams.map(teamName => {
        const teamData = allData.filter(p => p.team === teamName);
        const years = [...new Set(teamData.map(p => p.year))].sort();
        const totalPlayers = new Set(teamData.map(p => p.name)).size;
        
        // Filter games for this team
        const teamGames = allGames.filter(g =>
          g["home team"] === teamName || g["away team"] === teamName
        );
        
        console.log(`${teamName}: ${teamGames.length} games found`);
        
        const totalTeamGames = teamGames.length;
        const regularSeasonGames = teamGames.filter(g => g.game_type === 'Regular').length;
        const playoffGames = teamGames.filter(g => g.game_type === 'Playoff').length;
        
        const championships = calculateTeamChampionships(teamName);
        
        return {
          name: teamName,
          years: years,
          totalPlayers: totalPlayers,
          totalTeamGames: totalTeamGames,
          regularSeasonGames: regularSeasonGames,
          playoffGames: playoffGames,
          championships: championships,
          firstYear: years[0],
          lastYear: years[years.length - 1]
        };
      });
      
      const totalTeams = teams.length;
      const activeTeams = teamStats.filter(t => parseInt(t.lastYear) === 2025).length;
      const totalChampionships = teamStats.reduce((sum, t) => sum + t.championships.length, 0);
      
      document.getElementById("totalTeamsText").textContent =
        `${totalTeams} total teams (${activeTeams} active in 2025, ${totalTeams - activeTeams} inactive) • ${totalChampionships} championships awarded`;
      
      const container = document.getElementById("teams-container");
      container.innerHTML = '';
      
      teamStats.forEach(team => {
        const yearsText = team.years.length > 1 ?
          `${team.firstYear} - ${team.lastYear}` :
          team.firstYear;
        
        let gamesBreakdown = '';
        if (team.regularSeasonGames > 0 && team.playoffGames > 0) {
          gamesBreakdown = `${team.regularSeasonGames} regular season, ${team.playoffGames} playoff games`;
        } else if (team.regularSeasonGames > 0) {
          gamesBreakdown = `${team.regularSeasonGames} regular season games`;
        } else if (team.playoffGames > 0) {
          gamesBreakdown = `${team.playoffGames} playoff games`;
        } else if (team.totalTeamGames > 0) {
          gamesBreakdown = `${team.totalTeamGames} total games`;
        } else {
          gamesBreakdown = 'No games recorded';
        }
        
        let championshipHTML = '';
        if (team.championships.length > 0) {
          const championshipText = team.championships.length === 1 ?
            `🏆 ${team.championships[0]} Champions` :
            `🏆 ${team.championships.length} Championships`;
          championshipHTML = `<div class="championship-banner">${championshipText}</div>`;
        }
        
        const teamCard = document.createElement('a');
        teamCard.href = `team.html?team=${encodeURIComponent(team.name)}`;
        teamCard.className = 'team-card';
        
        teamCard.innerHTML = `
          <div class="team-header">
            <img src="logos/${team.name.toLowerCase().replace(/\s+/g, '_')}.png" 
                 alt="${team.name} Logo" 
                 class="team-logo" 
                 onerror="this.style.display='none';">
            <h3>${team.name}</h3>
          </div>
          <div class="team-details">
            <div class="team-years">Active: ${yearsText}</div>
            <div class="team-stats">
              <div class="stat-item">
                <span class="stat-number">${team.totalPlayers}</span>
                <div class="stat-label">Total Players</div>
              </div>
              <div class="stat-item">
                <span class="stat-number">${team.totalTeamGames}</span>
                <div class="stat-label">Total Games</div>
              </div>
              <div class="stat-item">
                <span class="stat-number">${team.years.length}</span>
                <div class="stat-label">Season${team.years.length !== 1 ? 's' : ''}</div>
              </div>
              <div class="stat-item">
                <span class="stat-number">${team.championships.length}</span>
                <div class="stat-label">Championship${team.championships.length !== 1 ? 's' : ''}</div>
              </div>
              ${team.totalTeamGames > 0 ? `<div class="games-breakdown">${gamesBreakdown}</div>` : ''}
            </div>
            ${championshipHTML}
          </div>
        `;
        
        container.appendChild(teamCard);
      });
    }

    function calculateTeamChampionships(teamName) {
      const championships = [];
      
      const teamGames = allGames.filter(g =>
        g["home team"] === teamName || g["away team"] === teamName
      );
      
      const teamSeasons = [...new Set(teamGames.map(g => `${g.year}-${g.season}`))];
      
      teamSeasons.forEach(seasonKey => {
        const [year, season] = seasonKey.split('-');
        
        const allPlayoffGames = allGames.filter(g =>
          g.year === year &&
          g.season === season &&
          g.game_type === 'Playoff'
        );
        
        if (allPlayoffGames.length === 0) return;
        
        const playoffStandings = calculatePlayoffStandings(allPlayoffGames);
        
        if (playoffStandings.length > 0 && playoffStandings[0].name === teamName) {
          championships.push(`${year} ${season}`);
        }
      });
      
      return championships;
    }

    function calculatePlayoffStandings(playoffGames) {
      const teamStats = {};
      
      playoffGames.forEach(game => {
        const homeTeam = game["home team"];
        const awayTeam = game["away team"];
        const winner = game.winner;
        
        if (!teamStats[homeTeam]) {
          teamStats[homeTeam] = { name: homeTeam, wins: 0, losses: 0, ties: 0, games: [] };
        }
        if (!teamStats[awayTeam]) {
          teamStats[awayTeam] = { name: awayTeam, wins: 0, losses: 0, ties: 0, games: [] };
        }
        
        // Track games for debugging
        teamStats[homeTeam].games.push(`vs ${awayTeam} (${winner === homeTeam ? 'W' : winner === awayTeam ? 'L' : 'T'})`);
        teamStats[awayTeam].games.push(`vs ${homeTeam} (${winner === awayTeam ? 'W' : winner === homeTeam ? 'L' : 'T'})`);
        
        if (winner === "Tie") {
          teamStats[homeTeam].ties++;
          teamStats[awayTeam].ties++;
        } else if (winner === homeTeam) {
          teamStats[homeTeam].wins++;
          teamStats[awayTeam].losses++;
        } else if (winner === awayTeam) {
          teamStats[awayTeam].wins++;
          teamStats[homeTeam].losses++;
        } else if (winner && winner.includes("Forfeit")) {
          const actualWinner = winner.replace("Forfeit - ", "").replace("Tie", "").trim();
          if (actualWinner && actualWinner !== "Tie") {
            if (actualWinner === homeTeam) {
              teamStats[homeTeam].wins++;
              teamStats[awayTeam].losses++;
            } else if (actualWinner === awayTeam) {
              teamStats[awayTeam].wins++;
              teamStats[homeTeam].losses++;
            }
          } else {
            teamStats[homeTeam].ties++;
            teamStats[awayTeam].ties++;
          }
        }
      });
      
      const standings = Object.values(teamStats).map(team => {
        const totalDecidedGames = team.wins + team.losses;
        team.winPct = totalDecidedGames > 0 ? team.wins / totalDecidedGames : 0;
        return team;
      });
      
      standings.sort((a, b) => {
        if (b.winPct !== a.winPct) {
          return b.winPct - a.winPct;
        }
        return b.wins - a.wins;
      });
      
      return standings;
    }

    loadData();
</script>

<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>