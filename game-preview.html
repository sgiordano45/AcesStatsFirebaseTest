<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Preview - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 3rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.header::after {
  content: '⚾';
  position: absolute;
  bottom: -40px;
  left: -40px;
  font-size: 200px;
  opacity: 0.05;
}

.header h1 {
  margin: 0;
  font-size: 3rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.header p {
  margin: 0.75rem 0 0 0;
  font-size: 1.2rem;
  opacity: 0.95;
  position: relative;
  z-index: 1;
}

/* Navigation */
.filters-nav {
  background: var(--card-bg);
  padding: 1.5rem;
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.nav-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  justify-content: center;
}

.nav-link {
  padding: 1rem 1.75rem;
  border: 2px solid var(--primary-color);
  background: white;
  color: var(--primary-color);
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.nav-link::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--primary-color);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: -1;
}

.nav-link:hover::before {
  transform: translateX(0);
}

.nav-link:hover {
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Container */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

/* Matchup Header */
.matchup-header {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.matchup-header::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.teams-display {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 3rem;
  margin: 1.5rem 0;
}

.team-info {
  text-align: center;
  flex: 1;
  max-width: 300px;
}

.team-logo {
  width: 100px !important;
  height: 100px !important;
  margin: 0 auto 1rem auto !important;
  border-radius: 50% !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  display: block !important;
  border: 3px solid var(--border-color) !important;
  transition: all 0.3s ease !important;
  object-fit: contain !important;
  background: white !important;
}

.team-logo:hover {
  transform: scale(1.1) !important;
  border-color: var(--primary-color) !important;
}

.team-name {
  font-size: 2rem;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.team-record {
  font-size: 1.2rem;
  color: var(--text-light);
  margin-bottom: 1rem;
  font-weight: 600;
}

.vs-divider {
  font-size: 3rem;
  font-weight: 800;
  color: var(--primary-color);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.game-details {
  background: #f8f9fa;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  margin-top: 1.5rem;
  font-size: 1.05rem;
  color: var(--text-dark);
  border: 1px solid var(--border-color);
}

/* Sections */
.section {
  background: var(--card-bg);
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.section:hover {
  box-shadow: var(--shadow-md);
}

.section-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  padding: 1.5rem 2rem;
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-header::before {
  content: "⚾";
  font-size: 1.5rem;
}

.peters-preview-header {
  background: linear-gradient(135deg, #d2691e 0%, #ff8c00 100%);
  color: white;
  padding: 1.5rem 2rem;
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.peters-preview-header::before {
  content: "🔮";
  font-size: 1.5rem;
}

.section-content {
  padding: 2rem;
}

/* Peters Preview */
.peters-preview-content {
  display: flex;
  align-items: flex-start;
  gap: 2rem;
}

.peters-preview-image {
  flex-shrink: 0;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid #d2691e;
  box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
  padding: 8px;
  background-color: #d2691e;
  overflow: hidden;
  transition: all 0.3s ease;
}

.peters-preview-image:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(210, 105, 30, 0.4);
}

.peters-preview-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  border-radius: 50%;
}

.peters-preview-main {
  flex: 1;
  min-width: 0;
}

/* Odds Display */
.odds-display {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
  border: 1px solid var(--border-color);
}

.odds-item {
  text-align: center;
  flex: 1;
  min-width: 120px;
}

.odds-team {
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.odds-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--primary-color);
  background: white;
  padding: 0.75rem 1.25rem;
  border-radius: 8px;
  border: 2px solid var(--primary-color);
  display: inline-block;
  transition: all 0.3s ease;
}

.odds-value:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-sm);
}

.favorite {
  color: #28a745;
  border-color: #28a745;
  background: #f8fff9;
}

/* Preview Text */
.preview-text {
  background: #ffffff;
  border-left: 4px solid #d2691e;
  padding: 1.5rem;
  border-radius: 0 12px 12px 0;
  line-height: 1.8;
  font-size: 1.05rem;
  color: var(--text-dark);
  margin-top: 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Comparison Grid */
.comparison-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 1.5rem;
  align-items: center;
}

.team-stats {
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.team-stats:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-sm);
}

.team-stats h4 {
  margin: 0 0 1rem 0;
  color: var(--text-dark);
  font-size: 1.3rem;
  font-weight: 700;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e9ecef;
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-label {
  font-weight: 600;
  color: var(--text-light);
  font-size: 0.95rem;
}

.stat-value {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 1.1rem;
}

.vs-label {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--primary-color);
  text-align: center;
  padding: 0 1rem;
}

/* H2H Summary */
.h2h-summary {
  text-align: center;
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 12px;
  margin: 1rem 0;
  border: 1px solid var(--border-color);
}

.h2h-record {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-dark);
}

/* History Table */
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.history-table th,
.history-table td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.history-table th {
  background-color: #f8f9fa;
  font-weight: 700;
  color: var(--text-dark);
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
}

.history-table tr:nth-child(even) {
  background-color: #fafafa;
}

.history-table tr:hover {
  background-color: #f0f0f0;
  transition: background-color 0.2s ease;
}

.winner-highlight {
  font-weight: 700;
  color: #28a745;
}

.no-data {
  text-align: center;
  padding: 3rem;
  color: var(--text-light);
  font-style: italic;
  font-size: 1.1rem;
}

.advantage {
  color: #28a745;
  font-weight: 700;
}

.disadvantage {
  color: #dc3545;
  font-weight: 700;
}

/* Key Players */
.key-players-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 1.5rem;
  align-items: flex-start;
}

.player-card {
  background: #f8f9fa;
  padding: 1.25rem;
  border-radius: 12px;
  margin-bottom: 0.75rem;
  border-left: 4px solid var(--primary-color);
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.player-card:hover {
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
  border-left-color: var(--secondary-color);
}

.player-name {
  font-weight: 700;
  font-size: 1.15rem;
  color: var(--text-dark);
  margin-bottom: 0.75rem;
}

.player-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  gap: 0.5rem;
}

.player-stat {
  text-align: center;
  flex: 1;
}

.player-stat-label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-light);
  margin-bottom: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.player-stat-value {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 1rem;
}

/* Fade in animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.section {
  animation: fadeInUp 0.6s ease backwards;
}

.section:nth-child(1) { animation-delay: 0.1s; }
.section:nth-child(2) { animation-delay: 0.2s; }
.section:nth-child(3) { animation-delay: 0.3s; }
.section:nth-child(4) { animation-delay: 0.4s; }
.section:nth-child(5) { animation-delay: 0.5s; }
.section:nth-child(6) { animation-delay: 0.6s; }

/* Responsive */
@media (max-width: 768px) {
  .header {
    padding: 2rem 1rem;
  }

  .header h1 {
    font-size: 2rem;
  }

  .container {
    padding: 1rem;
  }

  .section-content {
    padding: 1rem;
  }

  .teams-display {
    flex-direction: column;
    gap: 1rem;
  }

  .vs-divider {
    font-size: 2rem;
    transform: rotate(90deg);
  }

  .team-name {
    font-size: 1.5rem;
  }

  .team-logo {
    width: 80px !important;
    height: 80px !important;
  }

  .comparison-grid {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  .vs-label {
    display: none;
  }

  .odds-display {
    flex-direction: column;
    gap: 1rem;
  }

  .odds-item {
    min-width: 200px;
  }

  .peters-preview-content {
    flex-direction: column;
    align-items: center;
  }

  .peters-preview-image {
    width: 100px;
    height: 100px;
  }

  .nav-link {
    width: 100%;
    justify-content: center;
  }

  .history-table {
    font-size: 0.85rem;
  }

  .history-table th,
  .history-table td {
    padding: 0.6rem;
  }

  .player-stats {
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .player-stat {
    min-width: 60px;
  }
}
</style>
</head>
<body>
  <div class="filters-nav">

  </div>



  <header class="header">
    <h1>Game Preview</h1>
    <p id="gameInfo">Loading game details...</p>
  </header>

  <div class="container">
    <!-- Matchup Header -->
    <div class="matchup-header">
      <div class="teams-display">
        <div class="team-info" id="awayTeamInfo">
          <img class="team-logo" id="awayTeamLogo" src="" alt="" onerror="this.style.display='none'">
          <div class="team-name" id="awayTeamName">--</div>
          <div class="team-record" id="awayTeamRecord">--</div>
        </div>
        
        <div class="vs-divider">@</div>
        
        <div class="team-info" id="homeTeamInfo">
          <img class="team-logo" id="homeTeamLogo" src="" alt="" onerror="this.style.display='none'">
          <div class="team-name" id="homeTeamName">--</div>
          <div class="team-record" id="homeTeamRecord">--</div>
        </div>
      </div>
      
      <div class="game-details" id="gameDetails">
        Loading game details...
      </div>
    </div>

    <!-- Peters Preview -->
    <div class="section">
      <div class="peters-preview-header">
        Peters Preview
      </div>
      <div class="section-content">
        <div id="petersPreviewContent">
          Loading Peters Preview...
        </div>
      </div>
    </div>

    <!-- Head to Head Record -->
    <div class="section">
      <div class="section-header">
        Head-to-Head Record
      </div>
      <div class="section-content">
        <div class="h2h-summary" id="h2hSummary">
          Loading head-to-head record...
        </div>
      </div>
    </div>

    <!-- Key Players -->
    <div class="section">
      <div class="section-header">
        Key Players
      </div>
      <div class="section-content">
        <div class="comparison-grid" id="keyPlayersComparison">
          Loading key players...
        </div>
      </div>
    </div>

    <!-- Team Comparison -->
    <div class="section">
      <div class="section-header">
        Season Statistics Comparison
      </div>
      <div class="section-content">
        <h4 style="color: var(--text-dark); font-weight: 700; margin-bottom: 1rem;">Batting Statistics</h4>
        <div class="comparison-grid" id="battingComparison">
          Loading batting comparison...
        </div>
        
        <h4 style="margin-top: 2rem; color: var(--text-dark); font-weight: 700; margin-bottom: 1rem;">Pitching Statistics</h4>
        <div class="comparison-grid" id="pitchingComparison">
          Loading pitching comparison...
        </div>
      </div>
    </div>

    <!-- Historical Matchups -->
    <div class="section">
      <div class="section-header">
        Previous Matchups
      </div>
      <div class="section-content">
        <div id="historyContent">
          Loading matchup history...
        </div>
      </div>
    </div>
  </div>

  <script type="module">
      // ========================================
      // GAME PREVIEW - CONVERTED TO FIREBASE + OBJECT-KEYED SEASONS
      // ========================================
      // Replace the entire <script> section in game-preview.html with this code
      // Make sure to add type="module" to the script tag: <script type="module">

      import {
        getSeasonPlayerStatsOptimized,
        getSeasonPitchingStatsOptimized,
        getSeasonGames,
        getCurrentSeason,
        getAllSeasons
      } from './firebase-data.js';

      let allGames = [];
      let playerData = [];
      let pitchingData = [];
      let previewData = [];

      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const homeTeam = urlParams.get('home');
      const awayTeam = urlParams.get('away');
      const gameDate = urlParams.get('date');

      // Mobile menu toggle
      function toggleMobileMenu() {
        const menu = document.getElementById('mobileNavMenu');
        menu.classList.toggle('open');
      }
      window.toggleMobileMenu = toggleMobileMenu;

      if (!homeTeam || !awayTeam || !gameDate) {
        document.body.innerHTML = `
          <div class="container">
            <h1>Error: Missing game information</h1>
            <p><a href="current-season.html">Return to current season</a></p>
          </div>
        `;
      } else {
        loadGamePreviewData();
      }

      async function loadGamePreviewData() {
        const startTime = performance.now();
        console.log('🏟️ Loading game preview data...');
        
        try {
          // Helper function for capitalizing
          const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
          
          // Get current season from Firebase
          const currentSeasonData = await getCurrentSeason();
          const seasonId = currentSeasonData.id;
          
          console.log(`📅 Game season: ${seasonId}`);
          
          // Load data in parallel - following h2h_grid.html pattern for ALL games
          const [seasons, batting, pitching, previewsResponse] = await Promise.all([
            getAllSeasons(),
            getSeasonPlayerStatsOptimized(seasonId),
            getSeasonPitchingStatsOptimized(seasonId),
            fetch('previews.json', {
              headers: { 'Accept': 'application/json; charset=utf-8' }
            }).catch(() => ({ ok: false }))
          ]);
          
          console.log(`✅ Found ${seasons.length} seasons`);
          
          // Load games from ALL seasons (following h2h_grid.html pattern)
          const gamePromises = seasons.map(async (season) => {
            try {
              const seasonGames = await getSeasonGames(season.id);
              
              // Map games to expected format
              return seasonGames.map(g => {
                let dateString = "";
                if (g.date && g.date.seconds) {
                  const dateObj = new Date(g.date.seconds * 1000);
                  dateString = dateObj.toLocaleDateString('en-US');
                } else if (g.date) {
                  dateString = g.date;
                }
                
                return {
                  "home team": g.homeTeamName || capitalize(g.homeTeamId) || "",
                  "away team": g.awayTeamName || capitalize(g.awayTeamId) || "",
                  "home score": g.homeScore !== undefined ? g.homeScore : null,
                  "away score": g.awayScore !== undefined ? g.awayScore : null,
                  winner: capitalize(g.winner || ""),
                  game_type: g.gameType || "Regular",
                  date: dateString,
                  year: season.year.toString(),  // ← ADD .toString() HERE
                  season: capitalize(season.season || ""),
                  forfeit: g.forfeit ? "Yes" : "No"
                };
              });
            } catch (err) {
              console.warn(`Could not load games for season ${season.id}:`, err);
              return [];
            }
          });
          
          const allSeasonGames = await Promise.all(gamePromises);
          allGames = allSeasonGames.flat();
          
          console.log(`✅ Fetched: ${allGames.length} total games, ${batting?.length || 0} batting records, ${pitching?.length || 0} pitching records`);
          
          // Games are already mapped above - no need to map again
          // allGames already has all historical games in correct format
          
          // ====== MAP PLAYER DATA FROM FIREBASE ======
          // Use spread operator to keep ALL Firebase fields including acesBPI
          playerData = (batting || []).map(p => ({
            ...p, // Spread all Firebase fields
            name: p.playerName || p.name || p.id,
            team: p.team || p.currentTeam || "",
            year: currentSeasonData.year.toString(),
            season: capitalize(currentSeasonData.season),
            sub: "No"
          }));
          
          // ====== MAP PITCHING DATA FROM FIREBASE ======
          pitchingData = (pitching || []).map(p => ({
            name: p.playerName || p.name || p.id,
            team: p.team || p.currentTeam || "",
            year: currentSeasonData.year.toString(),
            season: capitalize(currentSeasonData.season),
            games: Number(p.games) || 0,
            IP: parseFloat(p.inningsPitched || p.IP || 0),
            "runs allowed": Number(p.runsAllowed || 0),
            ERA: p.earnedRunAverage || p.era || 0
          }));
          
          // Load preview data if available (still from JSON)
          if (previewsResponse.ok) {
            previewData = await previewsResponse.json();
          }
          
          const loadTime = performance.now() - startTime;
          console.log(`✅ Data loaded in ${loadTime.toFixed(0)}ms`);
          console.log(`📊 Games: ${allGames.length}, Players: ${playerData.length}, Pitchers: ${pitchingData.length}`);
          
          // Sample data for debugging
          if (playerData.length > 0) {
            console.log('🔍 Sample batting data:', playerData[0]);
            console.log('🔍 Check acesBPI field:', playerData[0].acesBPI);
          }
          if (pitchingData.length > 0) {
            console.log('🔍 Sample pitching data:', pitchingData[0]);
          }
          if (allGames.length > 0) {
            console.log('🔍 Sample game data:', allGames[0]);
          }
          
          generateGamePreview();
          
        } catch (error) {
          console.error('❌ Error loading data:', error);
          console.error('Error stack:', error.stack);
          document.body.innerHTML = `
            <div class="container">
              <h1>Error loading game preview data</h1>
              <p>Please try again later.</p>
              <p><a href="current-season.html">Return to current season</a></p>
            </div>
          `;
        }
      }

      function generateGamePreview() {
        console.log('🎨 Generating game preview...');
        
        // Update header
        document.getElementById('gameInfo').textContent = `${awayTeam} @ ${homeTeam} - ${gameDate}`;
        
        // Update team names and logos
        document.getElementById('awayTeamName').textContent = awayTeam;
        document.getElementById('homeTeamName').textContent = homeTeam;
        
        // Set team logos
        const awayLogo = document.getElementById('awayTeamLogo');
        const homeLogo = document.getElementById('homeTeamLogo');
        
        const awayLogoPath = `logos/${awayTeam.toLowerCase()}.png`;
        const homeLogoPath = `logos/${homeTeam.toLowerCase()}.png`;
        
        awayLogo.src = awayLogoPath;
        awayLogo.alt = `${awayTeam} logo`;
        
        homeLogo.src = homeLogoPath;
        homeLogo.alt = `${homeTeam} logo`;

        // Calculate current season records from Firebase games
        const currentSeasonGames = allGames.filter(g =>
          g.winner && g.winner.trim() !== ""
        );

        const homeRecord = calculateTeamRecord(homeTeam, currentSeasonGames);
        const awayRecord = calculateTeamRecord(awayTeam, currentSeasonGames);

        document.getElementById('homeTeamRecord').textContent =
          `${homeRecord.wins}-${homeRecord.losses}${homeRecord.ties > 0 ? `-${homeRecord.ties}` : ''} (${(homeRecord.winPct * 100).toFixed(1)}%)`;
        
        document.getElementById('awayTeamRecord').textContent =
          `${awayRecord.wins}-${awayRecord.losses}${awayRecord.ties > 0 ? `-${awayRecord.ties}` : ''} (${(awayRecord.winPct * 100).toFixed(1)}%)`;

        // Update game details
        document.getElementById('gameDetails').innerHTML = `
          <strong>Date:</strong> ${gameDate} | <strong>Type:</strong> Regular Season
        `;

        // Generate all sections
        generatePetersPreview(homeTeam, awayTeam, gameDate);
        generateHeadToHeadRecord(homeTeam, awayTeam);
        generateKeyPlayers(homeTeam, awayTeam);
        generateBattingComparison(homeTeam, awayTeam);
        generatePitchingComparison(homeTeam, awayTeam);
        generateHistoricalMatchups(homeTeam, awayTeam);
        
        console.log('✅ Game preview generated successfully!');
      }

      // Helper function to fix character encoding issues
      function cleanText(text) {
        if (!text) return text;
        
        return text
          .replace(/['']/g, "'")
          .replace(/[""]/g, '"')
          .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢/g, "'")
          .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g, '"')
          .replace(/ÃƒÂ¢Ã¢â€šÂ¬/g, '"')
          .replace(/ÃƒÂ¢Ã¢â€šÂ¬"/g, "—")
          .replace(/ÃƒÂ¢Ã¢â€šÂ¬"/g, "—");
      }

      function generatePetersPreview(homeTeam, awayTeam, gameDate) {
        // Find matching preview with flexible date matching
        const preview = previewData.find(p => {
          const matchesTeams = (p["home team"] === homeTeam && p["away team"] === awayTeam) ||
                             (p.home === homeTeam && p.away === awayTeam);
          const matchesDate = p.date === gameDate ||
                             formatDateForComparison(p.date) === formatDateForComparison(gameDate);
          return matchesTeams && matchesDate;
        });

        const petersSection = document.querySelector('.section:has(.peters-preview-header)');
        
        if (!preview || !preview.preview || preview.preview.trim() === '') {
          if (petersSection) {
            petersSection.style.display = 'none';
          }
          return;
        }

        if (petersSection) {
          petersSection.style.display = 'block';
        }

        // Parse odds
        const homeOdds = parseInt(preview["home odds"] || preview.odds?.home || 0);
        const awayOdds = parseInt(preview["away odds"] || preview.odds?.away || 0);
        
        let oddsHtml = '';
        if (homeOdds !== 0 || awayOdds !== 0) {
          const homeIsFavorite = homeOdds < 0 && (awayOdds > 0 || homeOdds > awayOdds);
          const awayIsFavorite = awayOdds < 0 && (homeOdds > 0 || awayOdds > homeOdds);

          oddsHtml = `
            <div class="odds-display">
              <div class="odds-item">
                <div class="odds-team">${awayTeam} (Away)</div>
                <div class="odds-value ${awayIsFavorite ? 'favorite' : ''}">${awayOdds > 0 ? '+' : ''}${awayOdds}</div>
              </div>
              <div class="odds-item">
                <div style="font-size: 1.2rem; color: #666;">Money Line</div>
              </div>
              <div class="odds-item">
                <div class="odds-team">${homeTeam} (Home)</div>
                <div class="odds-value ${homeIsFavorite ? 'favorite' : ''}">${homeOdds > 0 ? '+' : ''}${homeOdds}</div>
              </div>
            </div>
          `;
        }

        const previewHtml = `
          <div class="peters-preview-content">
            <div class="peters-preview-image" id="petersImageContainer">
              <img src="logos/peterpreview.png" alt="Peter's Preview" onerror="this.parentElement.style.display='none'">
            </div>
            <div class="peters-preview-main">
              ${oddsHtml}
              <div class="preview-text">
                ${cleanText(preview.preview)}
              </div>
            </div>
          </div>
        `;

        document.getElementById('petersPreviewContent').innerHTML = previewHtml;
      }

      function formatDateForComparison(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
      }

      function calculateTeamRecord(teamName, games) {
        const teamGames = games.filter(g =>
          g["home team"] === teamName || g["away team"] === teamName
        );

        let wins = 0, losses = 0, ties = 0;

        teamGames.forEach(game => {
          if (game.winner === "Tie") {
            ties++;
          } else if (game.winner === teamName) {
            wins++;
          } else {
            losses++;
          }
        });

        const totalDecided = wins + losses;
        const winPct = totalDecided > 0 ? wins / totalDecided : 0;

        return { wins, losses, ties, winPct };
      }

      function generateKeyPlayers(homeTeam, awayTeam) {
        console.log(`🌟 Generating key players for ${awayTeam} @ ${homeTeam}`);
        console.log(`📊 Total players in playerData: ${playerData.length}`);
        
        // Calculate team games played for qualification - ONLY CURRENT SEASON
        // Get the current season from the game date
        const gameYear = new Date(gameDate).getFullYear();
        const gameMonth = new Date(gameDate).getMonth() + 1;
        const currentSeasonName = gameMonth >= 8 ? 'Fall' : 'Spring';
        
        console.log(`🔍 Looking for games in ${gameYear} ${currentSeasonName}`);
        console.log(`🔍 Total games loaded: ${allGames.length}`);
        console.log(`🔍 Sample game from allGames:`, allGames[0]);
        
        // Check what years we have
        const uniqueYears = [...new Set(allGames.map(g => g.year))];
        console.log(`🔍 Years in games:`, uniqueYears.sort());
        
        // Check 2025 games specifically
        const games2025 = allGames.filter(g => g.year === "2025");
        console.log(`🔍 Total 2025 games: ${games2025.length}`);
        if (games2025.length > 0) {
          console.log(`🔍 Sample 2025 game:`, games2025[0]);
        }
        
        // Filter ALL games to current season only
        const currentSeasonGames = allGames.filter(g => {
          const matches = g.year === gameYear.toString() &&
                 g.season === currentSeasonName &&
                 g.winner &&
                 g.winner.trim() !== "";
          
          return matches;
        });
        
        console.log(`📊 Current season (${gameYear} ${currentSeasonName}): ${currentSeasonGames.length} total games`);
        
        // Count games for each team
        const teamGamesPlayed = {};
        currentSeasonGames.forEach(game => {
          const home = game["home team"];
          const away = game["away team"];
          teamGamesPlayed[home] = (teamGamesPlayed[home] || 0) + 1;
          teamGamesPlayed[away] = (teamGamesPlayed[away] || 0) + 1;
        });
        
        const homeTeamGames = teamGamesPlayed[homeTeam] || 0;
        const awayTeamGames = teamGamesPlayed[awayTeam] || 0;
        
        // Minimum 2 AB per team game to qualify
        const homeMinAB = homeTeamGames * 2;
        const awayMinAB = awayTeamGames * 2;
        
        console.log(`📊 ${homeTeam}: ${homeTeamGames} games (current season), min ${homeMinAB} AB`);
        console.log(`📊 ${awayTeam}: ${awayTeamGames} games (current season), min ${awayMinAB} AB`);
        
        // Filter players for each team
        const homeTopPlayers = playerData
          .filter(p => {
            const team = p.team || p.currentTeam || "";
            const atBats = Number(p.atBats || 0);
            const bpi = p.acesBPI || 0;
            
            const teamMatch = team === homeTeam;
            const abQualified = atBats >= homeMinAB;
            const hasBPI = bpi !== "N/A" && bpi != null && bpi !== 0;
            
            if (teamMatch && !abQualified) {
              console.log(`❌ ${p.name}: Only ${atBats} AB (need ${homeMinAB})`);
            }
            if (teamMatch && abQualified && !hasBPI) {
              console.log(`❌ ${p.name}: Qualified AB but acesBPI is ${bpi}`);
            }
            
            return teamMatch && abQualified && hasBPI;
          })
          .sort((a, b) => {
            const aBPI = parseFloat(a.acesBPI || 0);
            const bBPI = parseFloat(b.acesBPI || 0);
            return bBPI - aBPI;
          })
          .slice(0, 3);

        const awayTopPlayers = playerData
          .filter(p => {
            const team = p.team || p.currentTeam || "";
            const atBats = Number(p.atBats || 0);
            const bpi = p.acesBPI || 0;
            
            const teamMatch = team === awayTeam;
            const abQualified = atBats >= awayMinAB;
            const hasBPI = bpi !== "N/A" && bpi != null && bpi !== 0;
            
            if (teamMatch && !abQualified) {
              console.log(`❌ ${p.name}: Only ${atBats} AB (need ${awayMinAB})`);
            }
            if (teamMatch && abQualified && !hasBPI) {
              console.log(`❌ ${p.name}: Qualified AB but acesBPI is ${bpi}`);
            }
            
            return teamMatch && abQualified && hasBPI;
          })
          .sort((a, b) => {
            const aBPI = parseFloat(a.acesBPI || 0);
            const bBPI = parseFloat(b.acesBPI || 0);
            return bBPI - aBPI;
          })
          .slice(0, 3);

        console.log(`📊 ${awayTeam} qualified players:`, awayTopPlayers.length);
        console.log(`📊 ${homeTeam} qualified players:`, homeTopPlayers.length);
        
        if (awayTopPlayers.length > 0) {
          console.log(`🔍 Sample ${awayTeam} player:`, awayTopPlayers[0]);
        }
        if (homeTopPlayers.length > 0) {
          console.log(`🔍 Sample ${homeTeam} player:`, homeTopPlayers[0]);
        }

        function createPlayerCard(player) {
          const atBats = parseInt(player.atBats || 0);
          const hits = parseInt(player.hits || 0);
          const walks = parseInt(player.walks || 0);
          const runs = parseInt(player.runs || 0);
          
          const avg = atBats > 0 ? (hits / atBats).toFixed(3) : ".000";
          const obp = (atBats + walks) > 0 ? ((hits + walks) / (atBats + walks)).toFixed(3) : ".000";
          const acesBPI = parseFloat(player.acesBPI || 0).toFixed(1);
          const playerName = player.playerName || player.name || player.id || "Unknown";

          return `
            <div class="player-card">
              <div class="player-name">${playerName}</div>
              <div class="player-stats">
                <div class="player-stat">
                  <span class="player-stat-label">AVG</span>
                  <span class="player-stat-value">${avg}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">OBP</span>
                  <span class="player-stat-value">${obp}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">Runs</span>
                  <span class="player-stat-value">${runs}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">AcesBPI</span>
                  <span class="player-stat-value">${acesBPI}</span>
                </div>
              </div>
            </div>
          `;
        }

        const awayPlayersHtml = awayTopPlayers.length > 0
          ? awayTopPlayers.map(createPlayerCard).join('')
          : '<div class="no-data">No qualified players found</div>';
          
        const homePlayersHtml = homeTopPlayers.length > 0
          ? homeTopPlayers.map(createPlayerCard).join('')
          : '<div class="no-data">No qualified players found</div>';

        const keyPlayersHtml = `
          <div class="team-stats">
            <h4>${awayTeam} Top Players</h4>
            ${awayPlayersHtml}
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam} Top Players</h4>
            ${homePlayersHtml}
          </div>
        `;

        document.getElementById('keyPlayersComparison').innerHTML = keyPlayersHtml;
      }

      function generateHeadToHeadRecord(homeTeam, awayTeam) {
        const h2hGames = allGames.filter(g =>
          (g["home team"] === homeTeam && g["away team"] === awayTeam) ||
          (g["home team"] === awayTeam && g["away team"] === homeTeam)
        ).filter(g => g.winner && g.winner.trim() !== "");

        let homeWins = 0, awayWins = 0, ties = 0;

        h2hGames.forEach(game => {
          if (game.winner === "Tie") {
            ties++;
          } else if (game.winner === homeTeam) {
            homeWins++;
          } else if (game.winner === awayTeam) {
            awayWins++;
          }
        });

        const totalGames = homeWins + awayWins + ties;
        let recordText = "No previous matchups";
        
        if (totalGames > 0) {
          recordText = `All-time series: ${homeTeam} ${homeWins}-${awayWins}${ties > 0 ? `-${ties}` : ''} ${awayTeam} (${totalGames} games)`;
        }

        document.getElementById('h2hSummary').innerHTML = `
          <div class="h2h-record">${recordText}</div>
        `;
      }

      function generateBattingComparison(homeTeam, awayTeam) {
        const homeStats = calculateTeamBattingStats(homeTeam, playerData);
        const awayStats = calculateTeamBattingStats(awayTeam, playerData);

        const comparisonHtml = `
          <div class="team-stats">
            <h4>${awayTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team Avg</span>
              <span class="stat-value">.${awayStats.avg}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs/Game</span>
              <span class="stat-value">${awayStats.runsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Hits/Game</span>
              <span class="stat-value">${awayStats.hitsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Total Runs</span>
              <span class="stat-value">${awayStats.totalRuns}</span>
            </div>
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team Avg</span>
              <span class="stat-value">.${homeStats.avg}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs/Game</span>
              <span class="stat-value">${homeStats.runsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Hits/Game</span>
              <span class="stat-value">${homeStats.hitsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Total Runs</span>
              <span class="stat-value">${homeStats.totalRuns}</span>
            </div>
          </div>
        `;

        document.getElementById('battingComparison').innerHTML = comparisonHtml;
      }

      function generatePitchingComparison(homeTeam, awayTeam) {
        const homeStats = calculateTeamPitchingStats(homeTeam, pitchingData);
        const awayStats = calculateTeamPitchingStats(awayTeam, pitchingData);

        const comparisonHtml = `
          <div class="team-stats">
            <h4>${awayTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team ERA</span>
              <span class="stat-value">${awayStats.era}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Innings</span>
              <span class="stat-value">${awayStats.totalIP}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs Allowed</span>
              <span class="stat-value">${awayStats.totalRunsAllowed}</span>
            </div>
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team ERA</span>
              <span class="stat-value">${homeStats.era}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Innings</span>
              <span class="stat-value">${homeStats.totalIP}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs Allowed</span>
              <span class="stat-value">${homeStats.totalRunsAllowed}</span>
            </div>
          </div>
        `;

        document.getElementById('pitchingComparison').innerHTML = comparisonHtml;
      }

      function calculateTeamBattingStats(teamName, battingData) {
        const teamPlayers = battingData.filter(p => {
          const team = p.team || p.currentTeam || "";
          return team === teamName;
        });
        
        if (teamPlayers.length === 0) {
          return { avg: "000", runsPerGame: "0.0", hitsPerGame: "0.0", totalRuns: 0 };
        }

        const totalAtBats = teamPlayers.reduce((sum, p) => sum + (Number(p.atBats || 0)), 0);
        const totalHits = teamPlayers.reduce((sum, p) => sum + (Number(p.hits || 0)), 0);
        const totalRuns = teamPlayers.reduce((sum, p) => sum + (Number(p.runs || 0)), 0);
        const totalGames = Math.max(...teamPlayers.map(p => Number(p.games || 0)));

        const avg = totalAtBats > 0 ? Math.round((totalHits / totalAtBats) * 1000) : 0;
        const runsPerGame = totalGames > 0 ? (totalRuns / totalGames).toFixed(1) : "0.0";
        const hitsPerGame = totalGames > 0 ? (totalHits / totalGames).toFixed(1) : "0.0";

        return {
          avg: avg.toString().padStart(3, '0'),
          runsPerGame,
          hitsPerGame,
          totalRuns
        };
      }

      function calculateTeamPitchingStats(teamName, pitchingData) {
        const teamPitchers = pitchingData.filter(p => {
          const team = p.team || p.currentTeam || "";
          return team === teamName;
        });
        
        if (teamPitchers.length === 0) {
          return { era: "N/A", totalIP: "0.0", totalRunsAllowed: 0 };
        }

        const totalIP = teamPitchers.reduce((sum, p) => sum + parseFloat(p.inningsPitched || p.IP || 0), 0);
        const totalRunsAllowed = teamPitchers.reduce((sum, p) => sum + (Number(p.runsAllowed || p["runs allowed"] || 0)), 0);

        const era = totalIP > 0 ? ((totalRunsAllowed * 7) / totalIP).toFixed(2) : "N/A";

        return {
          era,
          totalIP: totalIP.toFixed(1),
          totalRunsAllowed
        };
      }

      function generateHistoricalMatchups(homeTeam, awayTeam) {
        const matchups = allGames.filter(g =>
          (g["home team"] === homeTeam && g["away team"] === awayTeam) ||
          (g["home team"] === awayTeam && g["away team"] === homeTeam)
        ).filter(g => g.winner && g.winner.trim() !== "")
        .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (matchups.length === 0) {
          document.getElementById('historyContent').innerHTML =
            '<div class="no-data">No previous matchups found between these teams.</div>';
          return;
        }

        const tableHtml = `
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Home Team</th>
                <th>Score</th>
                <th>Away Team</th>
                <th>Winner</th>
                <th>Season</th>
              </tr>
            </thead>
            <tbody>
              ${matchups.map(game => {
                const isWinner = (team) => game.winner === team ? 'winner-highlight' : '';
                const forfeit = game.forfeit === "Yes" ? " (Forfeit)" : "";
                
                return `
                  <tr>
                    <td>${game.date}</td>
                    <td class="${isWinner(game["home team"])}">${game["home team"]}</td>
                    <td>${game["home score"]} - ${game["away score"]}${forfeit}</td>
                    <td class="${isWinner(game["away team"])}">${game["away team"]}</td>
                    <td class="winner-highlight">${game.winner}</td>
                    <td>${game.season} ${game.year}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <div style="margin-top: 1rem; text-align: center; color: #666; font-size: 0.9rem;">
            Showing ${matchups.length} previous matchup${matchups.length !== 1 ? 's' : ''}
          </div>
        `;

        document.getElementById('historyContent').innerHTML = tableHtml;
      }
  </script>
  <script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
  <script src="team-colors.js"></script>
  <script src="mobile-enhancements.js"></script>
</body>
</html>
