<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Season Overview - Aces Stats</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    line-height: 1.6;
    color: var(--text-dark);
  }
  
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: '‚öæ';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0%, 100% { 
      transform: rotate(0deg) scale(1); 
    }
    50% { 
      transform: rotate(180deg) scale(1.1); 
    }
  }
  
  /* Back Navigation */
  .back-nav {
    background: var(--card-bg);
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }
  
  .back-nav a {
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--primary-color);
    background: white;
    color: var(--primary-color);
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s ease;
    display: inline-block;
    position: relative;
    overflow: hidden;
    z-index: 1;
  }

  .back-nav a::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: -1;
  }

  .back-nav a:hover::before {
    transform: translateX(0);
  }
  
  .back-nav a:hover {
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  /* Season Header */
  .season-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 4rem 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }
  
  .season-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .season-header::after {
    content: 'üìÖ';
    position: absolute;
    bottom: -30px;
    left: -30px;
    font-size: 200px;
    opacity: 0.08;
    transform: rotate(-15deg);
  }
  
  .season-header h1 {
    margin: 0 0 1.5rem 0;
    font-size: 3rem;
    font-weight: 800;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
  }
  
  .season-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.25rem;
    position: relative;
    z-index: 1;
  }
  
  .summary-item {
    text-align: center;
    padding: 1.5rem 1rem;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }

  .summary-item:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-4px);
  }
  
  .summary-number {
    font-size: 2em;
    font-weight: 800;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    color: var(--accent-color);
  }
  
  .summary-label {
    font-size: 0.95em;
    opacity: 0.95;
    font-weight: 600;
  }
  
  /* Leaders & Awards Container */
  .leaders-awards-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }
  
  .leaders-section, .awards-section, .games-section {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .leaders-section:hover, .awards-section:hover, .games-section:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }
  
  .leaders-section::before, .awards-section::before, .games-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 16px 16px 0 0;
  }
  
  .leaders-section h3, .awards-section h3, .games-section h3 {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    margin: 0;
    padding: 1.75rem;
    font-size: 1.4em;
    font-weight: 800;
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    position: relative;
  }

  .leaders-section h3::after, .awards-section h3::after, .games-section h3::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-color);
  }
  
  .leaders-table, .awards-table, .games-table {
    width: 100%;
    margin: 0;
  }
  
  .leaders-table th, .leaders-table td,
  .awards-table th, .awards-table td,
  .games-table th, .games-table td {
    padding: 1.25rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }
  
  .leaders-table th, .awards-table th, .games-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 700;
    color: var(--text-dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.9rem;
  }

  .leaders-table tr:nth-child(even),
  .awards-table tr:nth-child(even),
  .games-table tr:nth-child(even) {
    background-color: #fafbfc;
  }
  
  .leaders-table tr:hover,
  .awards-table tr:hover,
  .games-table tr:hover {
    background: linear-gradient(135deg, #f0f4f8 0%, #e9f0f7 100%);
  }
  
  .leaders-table a, .awards-table a, .games-table a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s ease;
  }
  
  .leaders-table a:hover, .awards-table a:hover, .games-table a:hover {
    color: var(--secondary-color);
    text-decoration: underline;
  }
  
  .stat-value {
    text-align: center;
    font-weight: 800;
    color: var(--text-dark);
  }
  
  /* View Switcher */
  .view-switcher {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }
  
  .view-switcher button {
    padding: 1rem 2.5rem;
    margin: 0 0.75rem;
    border: 2px solid var(--primary-color);
    border-radius: 12px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 700;
    transition: all 0.3s ease;
    background: white;
    color: var(--primary-color);
    position: relative;
    overflow: hidden;
    z-index: 1;
  }

  .view-switcher button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: -1;
  }

  .view-switcher button:hover::before {
    transform: translateX(0);
  }

  .view-switcher button:hover {
    color: white;
  }
  
  .view-switcher button.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .view-switcher button.active::before {
    transform: translateX(0);
  }
  
  /* Stats Table */
  .stats-table-container {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    position: relative;
  }
  
  .stats-table-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 16px 16px 0 0;
  }
  
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 0;
    background: white;
  }
  
  th, td {
    border: none;
    border-bottom: 1px solid var(--border-color);
    padding: 1.25rem 1rem;
    text-align: center;
    transition: background-color 0.2s ease;
  }
  
  th {
    cursor: pointer;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    font-weight: 700;
    user-select: none;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.9rem;
  }
  
  th:hover {
    background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
  }

  tbody tr:nth-child(even) {
    background-color: #fafbfc;
  }
  
  tbody tr:hover {
    background: linear-gradient(135deg, #f0f4f8 0%, #e9f0f7 100%);
  }
  
  table a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s ease;
  }
  
  table a:hover {
    color: var(--secondary-color);
    text-decoration: underline;
  }
  
  .loading {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light);
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    font-size: 1.1rem;
  }

  .loading::before {
    content: "‚öæ";
    display: block;
    font-size: 3rem;
    margin-bottom: 1rem;
    animation: spin 1.5s ease-in-out infinite;
  }
  
  .games-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    padding: 1.5rem;
  }
  
  .game-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
  }
  
  .game-section h4 {
    margin: 0 0 1rem 0;
    color: var(--primary-color);
    font-size: 1.2em;
    font-weight: 700;
  }
  
  .games-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .games-list::-webkit-scrollbar {
    width: 8px;
  }

  .games-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  .games-list::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 4px;
  }

  .games-list::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .page-container {
      padding: 1rem;
    }

    .season-header {
      padding: 2.5rem 1.5rem;
    }

    .season-header h1 {
      font-size: 2rem;
    }

    .season-header::after {
      font-size: 150px;
      bottom: -20px;
      left: -20px;
    }

    .summary-item {
      padding: 1.25rem 0.75rem;
    }

    .summary-number {
      font-size: 1.6em;
    }

    .leaders-awards-container, .games-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .view-switcher button {
      padding: 0.75rem 1.5rem;
      margin: 0.25rem;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75rem 0.5rem;
      font-size: 0.85rem;
    }

    .leaders-table th, .leaders-table td,
    .awards-table th, .awards-table td,
    .games-table th, .games-table td {
      padding: 1rem 0.75rem;
      font-size: 0.85rem;
    }
  }

  @media (max-width: 480px) {
    .season-header h1 {
      font-size: 1.75rem;
    }

    .summary-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .view-switcher {
      padding: 1rem;
    }

    .view-switcher button {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
    }

    th, td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8em;
    }
  }
</style>
<link rel="stylesheet" href="mobile-enhancements.css">
</head>
<body>
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="softball-spinner"></div>
</div>

<div class="page-container">
  <div class="back-nav">
    <a href="seasons.html">‚Üê Back to All Seasons</a>
  </div>

  <div class="season-header">
    <h1 id="seasonTitle">Season Overview</h1>
    
    <div class="season-summary" id="seasonSummary">
      <div class="loading">Loading season data...</div>
    </div>
  </div>

  <div class="leaders-awards-container">
    <div class="leaders-section">
      <h3 id="leadersTitle">Season Leaders</h3>
      <table class="leaders-table" id="leadersTable">
        <thead>
          <tr>
            <th>Statistic</th>
            <th>Player</th>
            <th class="stat-value">Value</th>
          </tr>
        </thead>
        <tbody id="leadersTableBody">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <div class="awards-section">
      <h3>Season Awards</h3>
      <table class="awards-table">
        <thead>
          <tr>
            <th>Award</th>
            <th>Player</th>
            <th>Team</th>
          </tr>
        </thead>
        <tbody id="awardsTableBody">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Regular Season Standings Section -->
  <div class="leaders-section" style="margin-bottom: 2rem;">
    <h3>Regular Season Standings</h3>
    <div id="regularStandingsContent" style="padding: 1rem;">
      <div class="loading">Loading standings...</div>
    </div>
  </div>

  <!-- Playoff Standings Section -->
  <div class="leaders-section" id="playoffStandingsSection" style="margin-bottom: 2rem; display: none;">
    <h3>Playoff Standings</h3>
    <div id="playoffStandingsContent" style="padding: 1rem;">
      <div class="loading">Loading standings...</div>
    </div>
  </div>

  <!-- Schedule Section -->
  <div class="games-section" style="margin-bottom: 2rem;">
    <h3>Season Schedule & Results</h3>
    <div id="scheduleContent" style="padding: 1rem;">
      <div class="loading">Loading schedule...</div>
    </div>
  </div>

  <div class="view-switcher">
    <button id="battingViewBtn" onclick="switchView('batting')" class="active">Batting Stats</button>
    <button id="pitchingViewBtn" onclick="switchView('pitching')">Pitching Stats</button>
  </div>

  <div class="stats-table-container">
    <table id="seasonStatsTable">
      <thead id="tableHead">
        <tr><th>Loading...</th></tr>
      </thead>
      <tbody>
        <tr><td>Loading season statistics...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
// Hide loading overlay when page loads
window.addEventListener('load', function() {
  setTimeout(function() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }, 800);
});

import {
  getAllPlayerStatsOptimized,
  getAllAwards,
  getSeasonGames,
  seasonsObjectToArray,
  pitchingSeasonsObjectToArray
} from './firebase-data.js';

let currentSeasonId = "";
let currentView = 'batting';
let seasonPlayers = [];
let seasonPitchers = [];
let seasonAwards = [];
let seasonGames = [];

// Get season from URL
const params = new URLSearchParams(window.location.search);
currentSeasonId = params.get("seasonId");

console.log('URL search params:', window.location.search);
console.log('All params:', Array.from(params.entries()));
console.log('seasonId from URL:', currentSeasonId);

// Support legacy URL format (year + season)
if (!currentSeasonId) {
  const year = params.get("year");
  const season = params.get("season");
  console.log('Trying legacy format - year:', year, 'season:', season);
  if (year && season) {
    currentSeasonId = `${year}-${season.toLowerCase()}`;
    console.log('Converted to seasonId:', currentSeasonId);
  }
}

// Normalize season ID (extract first two parts only)
if (currentSeasonId) {
  const parts = currentSeasonId.split('-');
  if (parts.length >= 2) {
    currentSeasonId = `${parts[0]}-${parts[1]}`;
    console.log('Normalized seasonId:', currentSeasonId);
  }
}

console.log('Final seasonId:', currentSeasonId);

if (!currentSeasonId) {
  document.body.innerHTML = `<div class="page-container">
    <h1>Error: Season not specified</h1>
    <p>URL: ${window.location.href}</p>
    <p>Search: ${window.location.search}</p>
    <p><a href="seasons.html">Return to all seasons</a></p>
  </div>`;
} else {
  loadSeasonData();
}

async function loadSeasonData() {
  try {
    console.log('Loading season:', currentSeasonId);
    
    // Load all players, awards, and games for this season
    const [allPlayers, allAwards, games] = await Promise.all([
      getAllPlayerStatsOptimized(),
      getAllAwards(),
      getSeasonGames(currentSeasonId).catch(err => {
        console.warn('Could not load games:', err);
        return []; // Return empty array if games fail to load
      })
    ]);
    
    console.log('Raw data loaded:', {
      totalPlayers: allPlayers.length,
      totalAwards: allAwards.length,
      totalGames: games.length
    });
    
    // Debug: Check what season keys exist in the first few players
    console.log('Sample player season keys:');
    allPlayers.slice(0, 5).forEach(p => {
      if (p.seasons && typeof p.seasons === 'object') {
        console.log(`${p.name} has seasons:`, Object.keys(p.seasons));
      }
    });
    
    // Filter batting stats for this season
    seasonPlayers = allPlayers
      .map(p => {
        let seasonData = null;
        
        if (p.seasons) {
          if (!Array.isArray(p.seasons) && typeof p.seasons === 'object') {
            const matchingKeys = Object.keys(p.seasons).filter(key =>
              key.startsWith(currentSeasonId)
            );
            
            if (matchingKeys.length > 0) {
              seasonData = p.seasons[matchingKeys[0]];
              console.log(`Player ${p.name} has object-keyed batting data for ${matchingKeys[0]}`);
            }
          } else if (Array.isArray(p.seasons)) {
            const seasonsArray = seasonsObjectToArray(p);
            const season = seasonsArray.find(s =>
              s.seasonId && s.seasonId.startsWith(currentSeasonId)
            );
            if (season) {
              seasonData = season;
              console.log(`Player ${p.name} has array-based batting data for ${season.seasonId}`);
            }
          }
        }
        
        if (seasonData) {
          return {
            ...seasonData,
            playerId: p.id,
            playerName: p.name
          };
        }
        return null;
      })
      .filter(p => p !== null);
    
    console.log('Filtered batting players for season:', seasonPlayers.length);
    
    // Filter pitching stats for this season
    seasonPitchers = allPlayers
      .map(p => {
        let pitchingData = null;
        
        if (p.pitchingSeasons) {
          if (!Array.isArray(p.pitchingSeasons) && typeof p.pitchingSeasons === 'object') {
            const matchingKeys = Object.keys(p.pitchingSeasons).filter(key =>
              key.startsWith(currentSeasonId)
            );
            
            if (matchingKeys.length > 0) {
              pitchingData = p.pitchingSeasons[matchingKeys[0]];
              console.log(`Player ${p.name} has object-keyed pitching data for ${matchingKeys[0]}`);
            }
          } else if (Array.isArray(p.pitchingSeasons)) {
            const pitchingSeasonsArray = pitchingSeasonsObjectToArray(p);
            const season = pitchingSeasonsArray.find(s =>
              s.seasonId && s.seasonId.startsWith(currentSeasonId)
            );
            if (season) {
              pitchingData = season;
              console.log(`Player ${p.name} has array-based pitching data for ${season.seasonId}`);
            }
          }
        }
        
        if (pitchingData) {
          return {
            ...pitchingData,
            playerId: p.id,
            playerName: p.name
          };
        }
        return null;
      })
      .filter(p => p !== null);
    
    console.log('Filtered pitching players for season:', seasonPitchers.length);
    
    seasonAwards = allAwards.filter(a => a.seasonId === currentSeasonId);
    seasonGames = games;
    
    console.log('‚úì Loaded:', {
      battingPlayers: seasonPlayers.length,
      pitchingPlayers: seasonPitchers.length,
      awards: seasonAwards.length,
      games: seasonGames.length
    });
    
    // Debug: Check what fields are available in player data
    if (seasonPlayers.length > 0) {
      console.log('Sample player fields:', Object.keys(seasonPlayers[0]));
      console.log('Sample player data:', seasonPlayers[0]);
    }
    
    // Debug: Check what fields are available in game data
    if (seasonGames.length > 0) {
      console.log('Sample game fields:', Object.keys(seasonGames[0]));
      console.log('Sample game data:', seasonGames[0]);
    }
    
    // Show the page even if no players (might have games/awards)
    if (seasonPlayers.length === 0 && seasonPitchers.length === 0 &&
        seasonGames.length === 0 && seasonAwards.length === 0) {
      document.body.innerHTML = `
        <div class="page-container">
          <h1>Season "${currentSeasonId}" not found</h1>
          <p>No data available for this season yet.</p>
          <p><a href="seasons.html">Return to all seasons</a></p>
        </div>
      `;
      return;
    }
    
    initializePage();
    
  } catch (error) {
    console.error("Error loading season data:", error);
    document.body.innerHTML = `
      <div class="page-container">
        <h1>Error loading season data</h1>
        <p>${error.message}</p>
        <p><a href="seasons.html">Return to all seasons</a></p>
      </div>
    `;
  }
}

function initializePage() {
  // Parse season ID for display
  const [year, season] = currentSeasonId.split('-');
  const displaySeason = season.charAt(0).toUpperCase() + season.slice(1);
  
  document.getElementById("seasonTitle").textContent = `${year} ${displaySeason} Season`;
  
  console.log('Initializing page with data:', {
    players: seasonPlayers.length,
    pitchers: seasonPitchers.length,
    awards: seasonAwards.length,
    games: seasonGames.length
  });
  
  renderSeasonSummary();
  renderStandings();
  renderAwards();
  renderSchedule();
  switchView('batting');
}

function renderSeasonSummary() {
  const uniquePlayers = new Set(seasonPlayers.map(p => p.playerName));
  const uniqueTeams = new Set(
    seasonPlayers
      .map(p => p.team)
      .filter(t => t && t.toLowerCase() !== "kings")
  );
  
  const totalAtBats = seasonPlayers.reduce((sum, p) => sum + (p.atBats || 0), 0);
  const totalHits = seasonPlayers.reduce((sum, p) => sum + (p.hits || 0), 0);
  const leagueBA = totalAtBats > 0 ? (totalHits / totalAtBats).toFixed(3) : ".000";
  
  // Count regular and playoff games
  const regularCount = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'regular' || gameType === '';
  }).length;
  const playoffCount = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'playoff';
  }).length;
  
  const gamesDisplay = playoffCount > 0
    ? `${seasonGames.length} (${regularCount} Regular, ${playoffCount} Playoff)`
    : seasonGames.length.toString();
  
  const summaryHTML = `
    <div class="summary-item">
      <div class="summary-number">${uniquePlayers.size}</div>
      <div class="summary-label">Players</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${uniqueTeams.size}</div>
      <div class="summary-label">Teams</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${gamesDisplay}</div>
      <div class="summary-label">Games</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${leagueBA}</div>
      <div class="summary-label">League BA</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${seasonAwards.length}</div>
      <div class="summary-label">Awards</div>
    </div>
  `;
  
  document.getElementById("seasonSummary").innerHTML = summaryHTML;
}

function renderAwards() {
  const tbody = document.getElementById("awardsTableBody");
  
  if (seasonAwards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No awards for this season</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  seasonAwards.forEach(award => {
    const playerLink = award.playerName ?
      `<a href="player.html?name=${encodeURIComponent(award.playerName)}">${award.playerName}</a>` :
      '';
    
    // Try multiple possible field names for team
    const teamName = award.teamName || award.Team || award.team || award.value || '';
    const teamLink = teamName ?
      `<a href="team.html?team=${encodeURIComponent(teamName)}">${teamName}</a>` :
      '';
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${award.category || award.Award || 'Award'}</strong></td>
        <td>${playerLink}</td>
        <td>${teamLink}</td>
      </tr>
    `;
  });
}

function renderStandings() {
  console.log('renderStandings called with', seasonGames.length, 'games');
  
  if (seasonGames.length === 0) {
    document.getElementById("regularStandingsContent").innerHTML =
      '<div style="text-align: center; padding: 2rem; color: #666;">No games available for standings</div>';
    return;
  }
  
  // Separate regular season and playoff games
  const regularGames = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'regular' || gameType === '';
  });
  
  const playoffGames = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'playoff';
  });
  
  // Render regular season standings
  if (regularGames.length > 0) {
    const regularStandings = calculateStandings(regularGames);
    document.getElementById("regularStandingsContent").innerHTML = renderStandingsTable(regularStandings);
  } else {
    document.getElementById("regularStandingsContent").innerHTML =
      '<div style="text-align: center; padding: 2rem; color: #666;">No regular season games</div>';
  }
  
  // Render playoff standings if there are playoff games
  if (playoffGames.length > 0) {
    document.getElementById('playoffStandingsSection').style.display = 'block';
    const playoffStandings = calculateStandings(playoffGames);
    document.getElementById("playoffStandingsContent").innerHTML = renderStandingsTable(playoffStandings);
  } else {
    document.getElementById('playoffStandingsSection').style.display = 'none';
  }
}

function calculateStandings(games) {
  const teams = {};
  
  games.forEach(game => {
    const homeTeam = game.homeTeamName || game.homeTeam;
    const awayTeam = game.awayTeamName || game.awayTeam;
    const winner = game.winner;
    
    if (!homeTeam || !awayTeam) return;
    
    // Initialize teams
    if (!teams[homeTeam]) {
      teams[homeTeam] = { name: homeTeam, wins: 0, losses: 0, ties: 0,
                          runsFor: 0, runsAgainst: 0, gamesPlayed: 0 };
    }
    if (!teams[awayTeam]) {
      teams[awayTeam] = { name: awayTeam, wins: 0, losses: 0, ties: 0,
                          runsFor: 0, runsAgainst: 0, gamesPlayed: 0 };
    }
    
    // Only count completed games
    if (winner && winner.trim() !== '') {
      teams[homeTeam].gamesPlayed++;
      teams[awayTeam].gamesPlayed++;
      
      const homeScore = parseInt(game.homeScore) || 0;
      const awayScore = parseInt(game.awayScore) || 0;
      
      teams[homeTeam].runsFor += homeScore;
      teams[homeTeam].runsAgainst += awayScore;
      teams[awayTeam].runsFor += awayScore;
      teams[awayTeam].runsAgainst += homeScore;
      
      // Compare winner case-insensitively
      const winnerLower = winner.toLowerCase();
      const homeLower = homeTeam.toLowerCase();
      const awayLower = awayTeam.toLowerCase();
      
      if (winnerLower === 'tie') {
        teams[homeTeam].ties++;
        teams[awayTeam].ties++;
      } else if (winnerLower === homeLower) {
        teams[homeTeam].wins++;
        teams[awayTeam].losses++;
      } else if (winnerLower === awayLower) {
        teams[awayTeam].wins++;
        teams[homeTeam].losses++;
      }
    }
  });
  
  // Convert to array and calculate percentages
  const standings = Object.values(teams).map(team => {
    const decidedGames = team.wins + team.losses;
    return {
      ...team,
      winPct: decidedGames > 0 ? team.wins / decidedGames : 0,
      runDiff: team.runsFor - team.runsAgainst
    };
  });
  
  // Sort by win percentage, then by wins
  standings.sort((a, b) => {
    if (b.winPct !== a.winPct) return b.winPct - a.winPct;
    return b.wins - a.wins;
  });
  
  return standings;
}

function renderStandingsTable(standings) {
  return `
    <table class="leaders-table" style="width: 100%;">
      <thead>
        <tr>
          <th style="text-align: center;">Rank</th>
          <th style="text-align: center;">Team</th>
          <th style="text-align: center;">W</th>
          <th style="text-align: center;">L</th>
          <th style="text-align: center;">T</th>
          <th style="text-align: center;">Win%</th>
          <th style="text-align: center;">RF</th>
          <th style="text-align: center;">RA</th>
          <th style="text-align: center;">Diff</th>
          <th style="text-align: center;">GP</th>
        </tr>
      </thead>
      <tbody>
        ${standings.map((team, index) => `
          <tr>
            <td style="text-align: center;">${index + 1}</td>
            <td style="text-align: center;"><a href="team.html?team=${encodeURIComponent(team.name)}">${team.name}</a></td>
            <td style="text-align: center;">${team.wins}</td>
            <td style="text-align: center;">${team.losses}</td>
            <td style="text-align: center;">${team.ties}</td>
            <td style="text-align: center; font-weight: bold; color: #22c55e;">${(team.winPct * 100).toFixed(1)}%</td>
            <td style="text-align: center;">${team.runsFor}</td>
            <td style="text-align: center;">${team.runsAgainst}</td>
            <td style="text-align: center; color: ${team.runDiff >= 0 ? '#22c55e' : '#ef4444'};">
              ${team.runDiff >= 0 ? '+' : ''}${team.runDiff}
            </td>
            <td style="text-align: center;">${team.gamesPlayed}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function renderSchedule() {
  console.log('renderSchedule called with', seasonGames.length, 'games');
  
  if (seasonGames.length === 0) {
    document.getElementById("scheduleContent").innerHTML =
      '<div style="text-align: center; padding: 2rem; color: #666;">No games scheduled</div>';
    return;
  }
  
  // Separate regular and playoff games (case-insensitive)
  const regularGames = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'regular' || gameType === '';
  });
  const playoffGames = seasonGames.filter(g => {
    const gameType = (g.gameType || '').toLowerCase();
    return gameType === 'playoff';
  });
  
  let html = '';
  
  if (regularGames.length > 0) {
    html += `
      <h4 style="margin: 0 0 1rem 0; color: #333;">Regular Season (${regularGames.length} games)</h4>
      <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
        <table class="leaders-table" style="width: 100%;">
          <thead>
            <tr>
              <th style="text-align: center;">Date</th>
              <th style="text-align: center;">Home Team</th>
              <th style="text-align: center;">Score</th>
              <th style="text-align: center;">Away Team</th>
              <th style="text-align: center;">Winner</th>
            </tr>
          </thead>
          <tbody>
            ${regularGames.map(g => {
              let dateStr = 'N/A';
              if (g.date) {
                if (g.date.toDate) {
                  dateStr = g.date.toDate().toLocaleDateString();
                } else {
                  dateStr = g.date;
                }
              }
              
              const scoreDisplay = `${g.homeScore || 0} - ${g.awayScore || 0}`;
              
              // Capitalize winner properly
              let winnerDisplay = '-';
              if (g.winner && g.winner.trim() !== '') {
                winnerDisplay = g.winner.charAt(0).toUpperCase() + g.winner.slice(1);
              }
              
              return `
                <tr>
                  <td style="white-space: nowrap; text-align: center;">${dateStr}</td>
                  <td style="text-align: center; font-weight: bold;">${g.homeTeamName || g.homeTeam || 'TBD'}</td>
                  <td style="text-align: center; font-weight: bold;">${scoreDisplay}</td>
                  <td style="text-align: center; font-weight: bold;">${g.awayTeamName || g.awayTeam || 'TBD'}</td>
                  <td style="text-align: center; font-weight: bold; color: #007bff;">${winnerDisplay}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  if (playoffGames.length > 0) {
    html += `
      <h4 style="margin: 2rem 0 1rem 0; color: #333;">Playoffs (${playoffGames.length} games)</h4>
      <div style="overflow-x: auto;">
        <table class="leaders-table" style="width: 100%;">
          <thead>
            <tr>
              <th style="text-align: center;">Date</th>
              <th style="text-align: center;">Home Team</th>
              <th style="text-align: center;">Score</th>
              <th style="text-align: center;">Away Team</th>
              <th style="text-align: center;">Winner</th>
            </tr>
          </thead>
          <tbody>
            ${playoffGames.map(g => {
              let dateStr = 'N/A';
              if (g.date) {
                if (g.date.toDate) {
                  dateStr = g.date.toDate().toLocaleDateString();
                } else {
                  dateStr = g.date;
                }
              }
              
              const scoreDisplay = `${g.homeScore || 0} - ${g.awayScore || 0}`;
              
              // Capitalize winner properly
              let winnerDisplay = '-';
              if (g.winner && g.winner.trim() !== '') {
                winnerDisplay = g.winner.charAt(0).toUpperCase() + g.winner.slice(1);
              }
              
              return `
                <tr style="background-color: #d1ecf1;">
                  <td style="white-space: nowrap; text-align: center;">${dateStr}</td>
                  <td style="text-align: center; font-weight: bold;">${g.homeTeamName || g.homeTeam || 'TBD'}</td>
                  <td style="text-align: center; font-weight: bold;">${scoreDisplay}</td>
                  <td style="text-align: center; font-weight: bold;">${g.awayTeamName || g.awayTeam || 'TBD'}</td>
                  <td style="text-align: center; font-weight: bold; color: #007bff;">${winnerDisplay}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  document.getElementById("scheduleContent").innerHTML = html;
}

window.switchView = function(view) {
  currentView = view;
  
  const battingBtn = document.getElementById('battingViewBtn');
  const pitchingBtn = document.getElementById('pitchingViewBtn');
  
  if (view === 'batting') {
    battingBtn.classList.add('active');
    pitchingBtn.classList.remove('active');
  } else {
    pitchingBtn.classList.add('active');
    battingBtn.classList.remove('active');
  }
  
  renderLeaders();
  renderStatsTable();
}

function renderLeaders() {
  const leadersTitle = document.getElementById('leadersTitle');
  const tbody = document.getElementById('leadersTableBody');
  
  if (currentView === 'batting') {
    leadersTitle.textContent = 'Batting Leaders';
    renderBattingLeaders(tbody);
  } else {
    leadersTitle.textContent = 'Pitching Leaders';
    renderPitchingLeaders(tbody);
  }
}

function renderBattingLeaders(tbody) {
  if (seasonPlayers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No batting data available</td></tr>';
    return;
  }
  
  const qualifyingBatters = seasonPlayers.filter(p => (p.atBats || 0) >= 20);
  
  const leaders = {
    'Games': seasonPlayers.reduce((prev, curr) =>
      (curr.games || 0) > (prev.games || 0) ? curr : prev, {games: -1}),
    'At Bats': seasonPlayers.reduce((prev, curr) =>
      (curr.atBats || 0) > (prev.atBats || 0) ? curr : prev, {atBats: -1}),
    'Hits': seasonPlayers.reduce((prev, curr) =>
      (curr.hits || 0) > (prev.hits || 0) ? curr : prev, {hits: -1}),
    'Runs': seasonPlayers.reduce((prev, curr) =>
      (curr.runs || 0) > (prev.runs || 0) ? curr : prev, {runs: -1}),
    'Walks': seasonPlayers.reduce((prev, curr) =>
      (curr.walks || 0) > (prev.walks || 0) ? curr : prev, {walks: -1}),
    'Batting Average': qualifyingBatters.length > 0 ? qualifyingBatters.reduce((prev, curr) => {
      const currBA = curr.atBats > 0 ? curr.hits / curr.atBats : 0;
      const prevBA = prev.atBats > 0 ? prev.hits / prev.atBats : 0;
      return currBA > prevBA ? curr : prev;
    }, {atBats: 0, hits: 0}) : null,
    'AcesBPI': seasonPlayers.reduce((prev, curr) => {
      const currWAR = curr.acesBPI || curr.AcesBPI || curr.AcesWar || curr.acesWar || curr.war || curr.WAR;
      const prevWAR = prev.acesBPI || prev.AcesBPI || prev.AcesWar || prev.acesWar || prev.war || prev.WAR;
      
      const currVal = (currWAR !== "N/A" && currWAR !== null && !isNaN(currWAR)) ?
        parseFloat(currWAR) : -999;
      const prevVal = (prevWAR !== "N/A" && prevWAR !== null && !isNaN(prevWAR)) ?
        parseFloat(prevWAR) : -999;
      return currVal > prevVal ? curr : prev;
    }, {})
  };
  
  tbody.innerHTML = '';
  Object.entries(leaders).forEach(([stat, player]) => {
    if (!player || !player.playerName) return;
    
    let value = '';
    switch(stat) {
      case 'Games': value = player.games || 0; break;
      case 'At Bats': value = player.atBats || 0; break;
      case 'Hits': value = player.hits || 0; break;
      case 'Runs': value = player.runs || 0; break;
      case 'Walks': value = player.walks || 0; break;
      case 'Batting Average':
        value = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000';
        break;
      case 'AcesBPI':
        const warValue = player.acesBPI || player.AcesBPI || player.AcesWar || player.acesWar || player.war || player.WAR;
        value = (warValue !== "N/A" && warValue !== null && !isNaN(warValue)) ?
          parseFloat(warValue).toFixed(2) : 'N/A';
        break;
    }
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${stat}</strong></td>
        <td><a href="player.html?name=${encodeURIComponent(player.playerName)}">${player.playerName}</a></td>
        <td class="stat-value">${value}</td>
      </tr>
    `;
  });
}

function renderPitchingLeaders(tbody) {
  if (seasonPitchers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No pitching data available</td></tr>';
    return;
  }
  
  const qualifyingPitchers = seasonPitchers.filter(p => (parseFloat(p.inningsPitched) || 0) >= 7);
  
  const leaders = {
    'Games': seasonPitchers.reduce((prev, curr) =>
      (curr.games || 0) > (prev.games || 0) ? curr : prev, {games: -1}),
    'Innings Pitched': seasonPitchers.reduce((prev, curr) => {
      const currIP = parseFloat(curr.inningsPitched) || 0;
      const prevIP = parseFloat(prev.inningsPitched) || 0;
      return currIP > prevIP ? curr : prev;
    }, {inningsPitched: 0}),
    'Runs Allowed': seasonPitchers.reduce((prev, curr) =>
      (curr.runsAllowed || 0) > (prev.runsAllowed || 0) ? curr : prev, {runsAllowed: -1}),
    'ERA': qualifyingPitchers.length > 0 ? qualifyingPitchers.reduce((prev, curr) => {
      const currERA = curr.earnedRunAverage !== "N/A" && !isNaN(curr.earnedRunAverage) ?
        parseFloat(curr.earnedRunAverage) : 999;
      const prevERA = prev.earnedRunAverage !== "N/A" && !isNaN(prev.earnedRunAverage) ?
        parseFloat(prev.earnedRunAverage) : 999;
      return currERA < prevERA ? curr : prev;
    }, {earnedRunAverage: 999}) : null
  };
  
  tbody.innerHTML = '';
  Object.entries(leaders).forEach(([stat, player]) => {
    if (!player || !player.playerName) return;
    
    let value = '';
    switch(stat) {
      case 'Games': value = player.games; break;
      case 'Innings Pitched': value = parseFloat(player.inningsPitched).toFixed(1); break;
      case 'Runs Allowed': value = player.runsAllowed; break;
      case 'ERA':
        value = player.earnedRunAverage !== "N/A" && !isNaN(player.earnedRunAverage) ?
          parseFloat(player.earnedRunAverage).toFixed(2) : 'N/A';
        break;
    }
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${stat}</strong></td>
        <td><a href="player.html?name=${encodeURIComponent(player.playerName)}">${player.playerName}</a></td>
        <td class="stat-value">${value}</td>
      </tr>
    `;
  });
}

function renderStatsTable() {
  const tableHead = document.getElementById('tableHead');
  const tbody = document.querySelector('#seasonStatsTable tbody');
  
  if (currentView === 'batting') {
    tableHead.innerHTML = `
      <tr>
        <th>Name</th>
        <th>Team</th>
        <th>Games</th>
        <th>At Bats</th>
        <th>Hits</th>
        <th>Runs</th>
        <th>Walks</th>
        <th>BA</th>
        <th>OBP</th>
        <th>AcesBPI</th>
      </tr>
    `;
    
    // Sort players by AcesBPI (highest to lowest)
    const sortedPlayers = [...seasonPlayers].sort((a, b) => {
      const aWAR = a.acesBPI || a.AcesBPI || a.AcesWar || a.acesWar || a.war || a.WAR;
      const bWAR = b.acesBPI || b.AcesBPI || b.AcesWar || b.acesWar || b.war || b.WAR;
      
      const aVal = (aWAR !== "N/A" && aWAR !== null && !isNaN(aWAR)) ? parseFloat(aWAR) : -999;
      const bVal = (bWAR !== "N/A" && bWAR !== null && !isNaN(bWAR)) ? parseFloat(bWAR) : -999;
      
      return bVal - aVal; // Descending order
    });
    
    tbody.innerHTML = '';
    sortedPlayers.forEach(p => {
      const BA = p.atBats > 0 ? (p.hits / p.atBats).toFixed(3) : ".000";
      const OBP = (p.atBats + p.walks) > 0
        ? ((p.hits + p.walks) / (p.atBats + p.walks)).toFixed(3)
        : ".000";
      
      const warValue = p.acesBPI || p.AcesBPI || p.AcesWar || p.acesWar || p.war || p.WAR;
      const war = (warValue !== "N/A" && warValue !== null && !isNaN(warValue)) ?
        parseFloat(warValue).toFixed(2) : 'N/A';

      tbody.innerHTML += `
        <tr>
          <td><a href="player.html?name=${encodeURIComponent(p.playerName)}">${p.playerName}</a></td>
          <td><a href="team.html?team=${encodeURIComponent(p.team)}">${p.team}</a></td>
          <td>${p.games || 0}</td>
          <td>${p.atBats || 0}</td>
          <td>${p.hits || 0}</td>
          <td>${p.runs || 0}</td>
          <td>${p.walks || 0}</td>
          <td>${BA}</td>
          <td>${OBP}</td>
          <td>${war}</td>
        </tr>
      `;
    });
  } else {
    tableHead.innerHTML = `
      <tr>
        <th>Name</th>
        <th>Team</th>
        <th>Games</th>
        <th>IP</th>
        <th>Runs Allowed</th>
        <th>ERA</th>
      </tr>
    `;
    
    // Sort pitchers by Games (most to least), then by ERA (lowest to highest)
    const sortedPitchers = [...seasonPitchers].sort((a, b) => {
      // First, sort by games (descending)
      const aGames = a.games || 0;
      const bGames = b.games || 0;
      
      if (bGames !== aGames) {
        return bGames - aGames;
      }
      
      // If games are equal, sort by ERA (ascending)
      const aERA = a.earnedRunAverage !== "N/A" && !isNaN(a.earnedRunAverage) ?
        parseFloat(a.earnedRunAverage) : 999;
      const bERA = b.earnedRunAverage !== "N/A" && !isNaN(b.earnedRunAverage) ?
        parseFloat(b.earnedRunAverage) : 999;
      
      return aERA - bERA;
    });
    
    tbody.innerHTML = '';
    sortedPitchers.forEach(p => {
      const ERA = p.earnedRunAverage !== "N/A" && !isNaN(p.earnedRunAverage)
        ? parseFloat(p.earnedRunAverage).toFixed(2)
        : "N/A";

      tbody.innerHTML += `
        <tr>
          <td><a href="player.html?name=${encodeURIComponent(p.playerName)}">${p.playerName}</a></td>
          <td><a href="team.html?team=${encodeURIComponent(p.team)}">${p.team}</a></td>
          <td>${p.games || 0}</td>
          <td>${parseFloat(p.inningsPitched || 0).toFixed(1)}</td>
          <td>${p.runsAllowed || 0}</td>
          <td>${ERA}</td>
        </tr>
      `;
    });
  }
}
</script>
<script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>
