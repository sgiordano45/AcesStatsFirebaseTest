<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pitcher Stats - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --pitching-primary: #11998e;
  --pitching-secondary: #38ef7d;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.softball-spinner::before {
  content: 'ü•é';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Header */
.page-header {
  background: linear-gradient(135deg, var(--pitching-primary) 0%, var(--pitching-secondary) 100%);
  padding: 4rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  color: white;
  text-align: center;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.page-header::after {
  content: 'ü•é';
  position: absolute;
  bottom: -30px;
  left: -30px;
  font-size: 200px;
  opacity: 0.05;
}

.page-header h1 {
  font-size: 3.5rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.page-header .subtitle {
  font-size: 1.3rem;
  font-weight: 300;
  opacity: 0.9;
  position: relative;
  z-index: 1;
}

/* Dashboard Container */
.page-container {
  max-width: 1400px;
  margin: 3rem auto;
  padding: 0 2rem;
}

/* Navigation Section */
.filters-nav {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  position: relative;
}

.filters-nav::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--pitching-primary) 0%, var(--pitching-secondary) 100%);
  border-radius: 16px 16px 0 0;
}

.nav-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.nav-link {
  padding: 0.8rem 1.5rem;
  border: 2px solid var(--primary-color);
  background: white;
  color: var(--primary-color);
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.nav-link::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--primary-color);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: -1;
}

.nav-link:hover::before {
  transform: translateX(0);
}

.nav-link:hover {
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.nav-link.pitching {
  border-color: var(--pitching-primary);
  color: var(--pitching-primary);
}

.nav-link.pitching::before {
  background: var(--pitching-primary);
}

/* Section */
.section {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  position: relative;
}

.section::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--pitching-primary) 0%, var(--pitching-secondary) 100%);
  border-radius: 16px 16px 0 0;
}

.section-title {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-dark);
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.section-title::before {
  content: "";
  width: 8px;
  height: 36px;
  background: linear-gradient(180deg, var(--pitching-primary) 0%, var(--pitching-secondary) 100%);
  border-radius: 4px;
}

/* Table Container */
.table-container {
  overflow-x: auto;
  border-radius: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  margin-top: 1.5rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, var(--pitching-primary) 0%, var(--pitching-secondary) 100%);
}

th {
  padding: 1rem;
  text-align: center;
  color: white;
  font-weight: 600;
  white-space: nowrap;
}

td {
  padding: 1rem;
  text-align: center;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-dark);
}

tbody tr {
  transition: all 0.3s ease;
}

tbody tr:nth-child(even) {
  background-color: #f8f9fa;
}

tbody tr:hover {
  background: linear-gradient(90deg, rgba(17,153,142,0.05) 0%, rgba(56,239,125,0.05) 100%);
  transform: scale(1.005);
  box-shadow: var(--shadow-sm);
}

.career-row {
  background: linear-gradient(135deg, rgba(17,153,142,0.1) 0%, rgba(56,239,125,0.1) 100%);
  font-weight: 600;
}

.career-row:hover {
  background: linear-gradient(135deg, rgba(17,153,142,0.15) 0%, rgba(56,239,125,0.15) 100%);
}

/* Back Button */
.back-button {
  margin-top: 2rem;
  padding: 1rem 2rem;
  background: white;
  border: 2px solid var(--pitching-primary);
  color: var(--pitching-primary);
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.back-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--pitching-primary);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: -1;
}

.back-button:hover::before {
  transform: translateX(0);
}

.back-button:hover {
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Error Message */
.error-message {
  text-align: center;
  padding: 3rem;
  color: var(--text-light);
}

.error-message h1 {
  color: #e53e3e;
  margin-bottom: 1rem;
}

/* Mobile Navigation */
.mobile-nav-container {
  display: none;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .page-header h1 {
    font-size: 2.5rem;
  }
  
  .page-header .subtitle {
    font-size: 1.1rem;
  }
  
  .page-container {
    padding: 0 1rem;
    margin: 2rem auto;
  }
  
  .section {
    padding: 1.5rem;
  }
  
  .section-title {
    font-size: 1.6rem;
  }
  
  .nav-container {
    flex-direction: column;
  }
  
  .nav-link {
    width: 100%;
    justify-content: center;
  }
  
  table {
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 0.6rem 0.4rem;
  }
  
  .mobile-nav-container {
    display: block;
  }
}

@media (max-width: 480px) {
  .page-header {
    padding: 3rem 1rem;
  }
  
  .page-header h1 {
    font-size: 2rem;
  }
  
  table {
    font-size: 0.75rem;
  }
  
  th, td {
    padding: 0.5rem 0.3rem;
  }
}
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>


<!-- Header -->
<div class="page-header">
  <h1 id="pitcherName">Loading...</h1>
  <div class="subtitle">Pitching Statistics</div>
</div>

<!-- Main Content -->
<div class="page-container">
  <!-- Navigation -->
  <div class="filters-nav">

  </div>

  <!-- Season Stats Section -->
  <div class="section">
    <div class="section-title">üìä Season Pitching Stats</div>
    <div class="table-container">
      <table id="seasonStatsTable">
        <thead>
          <tr>
            <th>Year</th>
            <th>Season</th>
            <th>Team</th>
            <th>Games</th>
            <th>Innings Pitched</th>
            <th>Runs Allowed</th>
            <th>ERA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Career Stats Section -->
  <div class="section">
    <div class="section-title">üèÜ Career Pitching Stats</div>
    <div class="table-container">
      <table id="careerStatsTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Games</th>
            <th>Innings Pitched</th>
            <th>Runs Allowed</th>
            <th>Career ERA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <button class="back-button" onclick="goBack()">‚Üê Back to Pitching Stats</button>
</div>

<script type="module">
  // Import Firebase functions
import { 
  getAllPlayerStatsOptimized,
  pitchingSeasonsObjectToArray,
  resolvePlayerName,
  getPlayerStatsOptimized
} from './firebase-data.js';

// Get pitcher ID or name from URL - support both for backwards compatibility
const urlParams = new URLSearchParams(window.location.search);
const pitcherId = urlParams.get('id');
const pitcherName = urlParams.get('name');

  // Helper function to capitalize strings
  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

  // Helper function to format player names
  function formatPlayerName(name) {
    if (!name) return "";
    
    if (name.includes(' ')) {
      return name.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    
    if (name.includes('_')) {
      return name.split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    
    return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  }

if (!pitcherId && !pitcherName) {
    document.body.innerHTML = `
      <div class="page-container">
        <div class="error-message">
          <h1>Error: No pitcher specified</h1>
          <div class="filters-nav">
            <nav class="nav-container">
              <a href="index.html" class="nav-link">üè† Home</a>
              <a href="players.html" class="nav-link">‚Üê Back to Players</a>
              <a href="pitching.html" class="nav-link pitching">ü•é Pitching Stats</a>
            </nav>
          </div>
          <p><a href="pitching.html">Return to pitching stats</a></p>
        </div>
      </div>
    `;
  } else {
    document.getElementById("pitcherName").textContent = pitcherName;
    loadPitcherData();
  }

async function loadPitcherData() {
  console.log('‚ö° Loading pitcher data from Firebase...');
  
  try {
    let pitcher = null;
    let resolvedName = pitcherName;
    
    // NEW: Try to resolve pitcher by ID or name
    if (pitcherId) {
      console.log(`üîç Looking up pitcher by ID: ${pitcherId}`);
      pitcher = await getPlayerStatsOptimized(pitcherId);
      
      if (!pitcher || pitcher.migrated) {
        console.warn('‚ö†Ô∏è Pitcher ID not found or is migrated, trying name fallback');
        pitcher = await resolvePlayerName(pitcherId);
      }
    } else if (pitcherName) {
      console.log(`üîç Looking up pitcher by name: ${pitcherName}`);
      pitcher = await resolvePlayerName(pitcherName);
    }
    
    if (!pitcher) {
      showError(`Pitcher "${pitcherName || pitcherId}" not found`);
      return;
    }
    
    console.log(`‚úÖ Resolved to: "${pitcher.name}" (ID: ${pitcher.id})`);
    
    // Update URL to use ID if we came from name
    if (pitcherName && !pitcherId) {
      const newUrl = `${window.location.pathname}?id=${pitcher.id}`;
      window.history.replaceState({}, '', newUrl);
      console.log('üîÑ Updated URL to ID-based');
    }
    
    // Update page title with resolved name
    resolvedName = pitcher.name || pitcher.displayName;
    document.getElementById("pitcherName").textContent = resolvedName;

    // Process pitching seasons from OBJECT format
    const pitcherData = [];
    
    if (pitcher.pitchingSeasons && typeof pitcher.pitchingSeasons === 'object') {
      const pitchingSeasonsArray = pitchingSeasonsObjectToArray(pitcher);
      
      pitchingSeasonsArray.forEach(season => {
        let year = "";
        let seasonName = "";
        
        if (season.seasonId) {
          const parts = season.seasonId.split('-');
          if (parts.length >= 2) {
            year = parts[0];
            seasonName = parts[1];
          }
        }
        
        if (!year && season.year) year = season.year;
        if (!seasonName && season.season) seasonName = season.season;
        
        let eraValue = "N/A";
        if (season.earnedRunAverage !== undefined && season.earnedRunAverage !== null && season.earnedRunAverage !== "N/A") {
          eraValue = Number(season.earnedRunAverage);
        }
        
        pitcherData.push({
          year: year,
          season: capitalize(seasonName),
          team: capitalize(season.team || pitcher.currentTeam || ""),
          games: Number(season.games) || 0,
          IP: typeof season.inningsPitched === 'number' ? season.inningsPitched.toString() :
              (season.inningsPitched || "0"),
          runsAllowed: Number(season.runsAllowed) || 0,
          ERA: eraValue
        });
      });
    }

    if (pitcherData.length === 0) {
      showError(`No pitching data found for "${resolvedName}"`);
      return;
    }

    console.log(`‚úÖ Found ${pitcherData.length} pitching seasons for ${resolvedName}`);

    // Sort by year (most recent first), then by season
    const seasonOrder = { 'Fall': 3, 'Summer': 2, 'Spring': 1 };
    const sortedSeasons = pitcherData.sort((a, b) => {
      if (a.year !== b.year) return b.year.localeCompare(a.year);
      const seasonA = seasonOrder[a.season] || 0;
      const seasonB = seasonOrder[b.season] || 0;
      return seasonB - seasonA;
    });

    // Render tables
    renderSeasonTable(sortedSeasons);
    renderCareerStats(pitcherData);

    // Hide loading overlay
    document.getElementById('loadingOverlay').classList.add('hidden');

  } catch (error) {
    console.error('‚ùå Error loading pitcher data:', error);
    showError('Error loading pitcher data. Please try again.');
  }
}
  function showError(message) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.querySelector('.page-container').innerHTML = `
      <div class="error-message">
        <h1>${message}</h1>
        <div class="filters-nav">
          <nav class="nav-container">
            <a href="index.html" class="nav-link">üè† Home</a>
            <a href="players.html" class="nav-link">‚Üê Back to Players</a>
            <a href="pitching.html" class="nav-link pitching">ü•é Pitching Stats</a>
          </nav>
        </div>
        <p><a href="pitching.html">Return to pitching stats</a></p>
      </div>
    `;
  }

  function renderSeasonTable(data) {
    const tbody = document.querySelector('#seasonStatsTable tbody');
    tbody.innerHTML = "";
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">No data available</td></tr>';
      return;
    }

    data.forEach(p => {
      const eraDisplay = (p.ERA === "N/A" || isNaN(p.ERA)) ? "N/A" : Number(p.ERA).toFixed(2);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.year}</td>
        <td>${p.season}</td>
        <td>${p.team}</td>
        <td>${p.games}</td>
        <td>${p.IP}</td>
        <td>${p.runsAllowed}</td>
        <td>${eraDisplay}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function renderCareerStats(data) {
    const tbody = document.querySelector('#careerStatsTable tbody');
    tbody.innerHTML = "";

    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
      return;
    }

    // Calculate career totals
    const totalGames = data.reduce((sum, p) => sum + p.games, 0);
    const totalIP = data.reduce((sum, p) => sum + (parseFloat(p.IP) || 0), 0);
    const totalRunsAllowed = data.reduce((sum, p) => sum + p.runsAllowed, 0);

    // Calculate career ERA as weighted average
    let careerERA = "N/A";
    const validERASeasons = data.filter(p => p.ERA !== "N/A" && !isNaN(p.ERA) && parseFloat(p.IP) > 0);
    
    if (validERASeasons.length > 0) {
      let totalEarnedRuns = 0;
      let totalInnings = 0;
      
      validERASeasons.forEach(p => {
        const ip = parseFloat(p.IP);
        const earnedRuns = (Number(p.ERA) * ip) / 7;
        totalEarnedRuns += earnedRuns;
        totalInnings += ip;
      });
      
      if (totalInnings > 0) {
        careerERA = ((totalEarnedRuns * 7) / totalInnings).toFixed(2);
      }
    }

    const row = document.createElement('tr');
    row.className = 'career-row';
    row.innerHTML = `
      <td><strong>Career Total</strong></td>
      <td>${totalGames}</td>
      <td>${totalIP.toFixed(1)}</td>
      <td>${totalRunsAllowed}</td>
      <td>${careerERA}</td>
    `;
    tbody.appendChild(row);
  }

  function goBack() {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = 'pitching.html';
    }
  }

  // Make goBack available globally
  window.goBack = goBack;
</script>
<script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>