<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.softball-spinner::before {
  content: '‚öæ';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  padding: 3rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 300px;
  height: 300px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

.profile-header-section {
  display: flex;
  align-items: center;
  gap: 2rem;
  color: white;
}

.profile-photo-container {
  position: relative;
}

.profile-photo {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.3);
  object-fit: cover;
  box-shadow: var(--shadow-md);
}

.profile-info {
  flex: 1;
}

.profile-info h1 {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.profile-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.profile-badge {
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}
.back-home-btn {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
      z-index: 2;
    }

    .back-home-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
/* Navigation Tabs */
.nav-tabs {
  background: white;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-tabs-container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  overflow-x: auto;
  scrollbar-width: none;
}

.nav-tabs-container::-webkit-scrollbar {
  display: none;
}

.nav-tab {
  padding: 1.2rem 2rem;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-light);
  transition: all 0.3s ease;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.nav-tab:hover {
  color: var(--primary-color);
  background: rgba(45, 80, 22, 0.05);
}

.nav-tab.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: rgba(45, 80, 22, 0.05);
}

/* Main Content */
.main-content {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 2rem 2rem;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Cards */
.section-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.section-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid;
  border-image: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%) 1;
}

.section-header h2 {
  font-size: 1.5rem;
  color: var(--text-dark);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-icon {
  font-size: 1.8rem;
}

/* Form Elements */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  font-weight: 600;
  color: var(--text-dark);
  font-size: 0.95rem;
}

.form-input,
.form-select {
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.form-input:disabled,
.form-select:disabled {
  background: #f7fafc;
  cursor: not-allowed;
  opacity: 0.6;
}

/* Buttons */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-family: inherit;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background: white;
  color: var(--primary-color);
  border: 2px solid var(--primary-color);
}

.btn-secondary:hover {
  background: var(--primary-color);
  color: white;
}

.btn-group {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1.5rem;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.stat-box {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 1.5rem;
  border-radius: 8px;
  text-align: center;
  border: 2px solid var(--border-color);
  transition: all 0.3s ease;
}

.stat-box:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

/* Favorites Section */
.favorites-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.favorite-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  padding: 1.25rem;
  transition: all 0.3s ease;
  position: relative;
}

.favorite-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
}

.favorite-card-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.favorite-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  font-size: 1.5rem;
}

.favorite-card-title {
  flex: 1;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--text-dark);
}

.remove-favorite {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
  font-size: 1.2rem;
  padding: 0.25rem;
  line-height: 1;
  transition: color 0.3s ease;
}

.remove-favorite:hover {
  color: #dc3545;
}

.favorite-stats {
  font-size: 0.9rem;
  color: var(--text-light);
  line-height: 1.6;
}

.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-light);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

/* Toggle Switch */
.toggle-group {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  border-radius: 26px;
  transition: 0.4s;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  border-radius: 50%;
  transition: 0.4s;
}

.toggle-switch input:checked + .toggle-slider {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* Quick Links */
.quick-links {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.quick-link-card {
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  text-decoration: none;
  color: var(--text-dark);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.quick-link-card:hover {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.1) 0%, rgba(26, 107, 74, 0.1) 100%);
  transform: translateX(5px);
}

.quick-link-icon {
  font-size: 2rem;
}

.quick-link-content h3 {
  font-size: 1rem;
  margin-bottom: 0.25rem;
  color: var(--primary-color);
}

.quick-link-content p {
  font-size: 0.85rem;
  color: var(--text-light);
  margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .back-home-btn {
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  .profile-header-section {
    flex-direction: column;
    text-align: center;
  }

  .profile-info h1 {
    font-size: 2rem;
  }

  .nav-tab {
    padding: 1rem 1.5rem;
    font-size: 0.9rem;
  }

  .main-content {
    padding: 0 1rem 1rem;
  }

  .section-card {
    padding: 1.5rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .quick-links {
    grid-template-columns: 1fr;
  }
}

/* Success Message */
.success-message {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  display: none;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.success-message.show {
  display: block;
}

/* Selection Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  overflow-y: auto;
  padding: 2rem;
}

.modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  padding: 1.5rem 2rem;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
}

.modal-header h2 {
  font-size: 1.5rem;
  color: var(--text-dark);
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-light);
  padding: 0.5rem;
  line-height: 1;
  transition: color 0.3s ease;
}

.modal-close:hover {
  color: var(--text-dark);
}

.modal-body {
  padding: 1.5rem 2rem;
  overflow-y: auto;
  flex: 1;
}

.modal-search {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  margin-bottom: 1.5rem;
  font-family: inherit;
}

.modal-search:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.selection-list {
  display: grid;
  gap: 0.75rem;
}

.selection-item {
  padding: 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
}

.selection-item:hover {
  border-color: var(--primary-color);
  background: rgba(45, 80, 22, 0.03);
  transform: translateX(5px);
}

.selection-item.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
}

.selection-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.selection-item.disabled:hover {
  border-color: var(--border-color);
  background: white;
  transform: none;
}

.selection-item-info {
  flex: 1;
}

.selection-item-name {
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.25rem;
}

.selection-item-details {
  font-size: 0.875rem;
  color: var(--text-light);
}

.selection-item-badge {
  background: var(--primary-color);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.modal-footer {
  padding: 1.5rem 2rem;
  border-top: 2px solid var(--border-color);
  display: flex;
  gap: 1rem;
  background: #f7fafc;
}

.modal-footer .btn {
  flex: 1;
}
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="softball-spinner"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
        <a href="index.html" class="back-home-btn">
          <span>‚Üê</span> Back Home
        </a>
      <div class="profile-header-section">
        <div class="profile-photo-container">
          <img src="" alt="Profile Photo" class="profile-photo" id="profilePhoto">
        </div>
        <div class="profile-info">
          <h1 id="displayName">Loading...</h1>
          <div class="profile-subtitle">
            <span id="playerName">Player Name</span>
            <span class="profile-badge" id="teamBadge">Team Name</span>
            <span class="profile-badge" id="memberSince">Member since 2024</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="nav-tabs">
    <div class="nav-tabs-container">
      <button class="nav-tab active" data-tab="overview">
        <span>üìä</span> Overview
      </button>
      <button class="nav-tab" data-tab="player-info">
        <span>‚öæ</span> Player Info
      </button>
      <button class="nav-tab" data-tab="favorites">
        <span>‚≠ê</span> Favorites
      </button>
      <button class="nav-tab" data-tab="preferences">
        <span>‚öôÔ∏è</span> Preferences
      </button>
      <button class="nav-tab" data-tab="security">
        <span>üîí</span> Security
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üìà</span> Season Statistics</h2>
        </div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="statGames">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statAvg">.000</div>
            <div class="stat-label">Batting Average</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statHits">0</div>
            <div class="stat-label">Total Hits</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statRuns">0</div>
            <div class="stat-label">Runs Scored</div>
          </div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîó</span> Quick Links</h2>
        </div>
        <div class="quick-links">
          <a href="#" class="quick-link-card" id="linkMyStats">
            <div class="quick-link-icon">üìä</div>
            <div class="quick-link-content">
              <h3>View My Stats</h3>
              <p>Full career statistics</p>
            </div>
          </a>
          <a href="#" class="quick-link-card" id="linkMyTeam">
            <div class="quick-link-icon">üë•</div>
            <div class="quick-link-content">
              <h3>My Team</h3>
              <p>Team roster & schedule</p>
            </div>
          </a>
          <a href="favorites.html" class="quick-link-card">
            <div class="quick-link-icon">‚≠ê</div>
            <div class="quick-link-content">
              <h3>My Favorites</h3>
              <p>Track teams & players</p>
            </div>
          </a>
          <a href="roster-management.html" class="quick-link-card" id="linkRSVP">
            <div class="quick-link-icon">‚úî</div>
            <div class="quick-link-content">
              <h3>Game RSVPs</h3>
              <p>Manage availability</p>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Player Info Tab -->
    <div class="tab-content" id="tab-player-info">
      <!-- NEW: Display Name Section -->
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üë§</span> Display Name</h2>
        </div>
        <div id="successMessageDisplayName" class="success-message">
          Display name updated successfully!
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          This is how your name will appear throughout the site. Leave blank to use your Google account name.
        </p>
        <form id="displayNameForm">
          <div class="form-group">
            <label class="form-label" for="preferredDisplayName">Preferred Display Name</label>
            <input type="text" id="preferredDisplayName" class="form-input" placeholder="e.g., Steve instead of Stephen">
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
              Current Google account name: <strong id="googleAccountName"></strong>
            </small>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Display Name
            </button>
            <button type="button" class="btn btn-secondary" id="clearDisplayName">
              ‚úñÔ∏è Use Google Name
            </button>
          </div>
        </form>
      </div>

      <!-- EXISTING: Player Information Section -->
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">‚öæ</span> Player Information</h2>
        </div>
        <div id="successMessagePlayerInfo" class="success-message">
          Changes saved successfully!
        </div>
        <form id="playerInfoForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="nickname">Nickname</label>
              <input type="text" id="nickname" class="form-input" placeholder="Enter nickname">
            </div>
            <div class="form-group">
              <label class="form-label" for="jerseyNumber">Jersey Number(s)</label>
              <input type="text" id="jerseyNumber" class="form-input" placeholder="e.g., 24, 42">
            </div>
            <div class="form-group">
              <label class="form-label" for="battingSide">Bats</label>
              <select id="battingSide" class="form-select">
                <option value="">Select...</option>
                <option value="right">Right</option>
                <option value="left">Left</option>
                <option value="switch">Switch</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="throwingArm">Throws</label>
              <select id="throwingArm" class="form-select">
                <option value="">Select...</option>
                <option value="right">Right</option>
                <option value="left">Left</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="primaryPosition">Primary Position</label>
              <select id="primaryPosition" class="form-select">
                <option value="">Select...</option>
                <option value="pitcher">Pitcher</option>
                <option value="catcher">Catcher</option>
                <option value="1b">First Base</option>
                <option value="2b">Second Base</option>
                <option value="3b">Third Base</option>
                <option value="ss">Shortstop</option>
                <option value="if">Infield</option>
                <option value="lf">Left Field</option>
                <option value="cf">Center Field</option>
                <option value="rf">Right Field</option>
                <option value="of">Outfield</option>
                <option value="utility">Utility</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="secondaryPositions">Secondary Positions</label>
              <input type="text" id="secondaryPositions" class="form-input" placeholder="e.g., 2B, SS, OF">
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Changes
            </button>
            <button type="button" class="btn btn-secondary" id="cancelPlayerInfo">
              ‚úñÔ∏è Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Favorites Tab -->
    <div class="tab-content" id="tab-favorites">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üèÜ</span> Favorite Teams</h2>
          <button class="btn btn-secondary" id="addFavoriteTeam">
            + Add Team
          </button>
        </div>
        <div class="favorites-grid" id="favoriteTeamsGrid">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">‚≠ê</span> Favorite Players (Max 10)</h2>
          <button class="btn btn-secondary" id="addFavoritePlayer">
            + Add Player
          </button>
        </div>
        <div class="favorites-grid" id="favoritePlayersGrid">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>

    <!-- Preferences Tab -->
    <div class="tab-content" id="tab-preferences">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîî</span> Notifications</h2>
        </div>
        <div id="successMessagePreferences" class="success-message">
          Preferences saved successfully!
        </div>
        <form id="preferencesForm">
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Email Notifications for Game Reminders</span>
              <label class="toggle-switch">
                <input type="checkbox" id="emailGameReminders" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Email Notifications for Score Updates</span>
              <label class="toggle-switch">
                <input type="checkbox" id="emailScoreUpdates">
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Favorite Team Notifications</span>
              <label class="toggle-switch">
                <input type="checkbox" id="favoriteTeamNotifications" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Favorite Player Milestone Alerts</span>
              <label class="toggle-switch">
                <input type="checkbox" id="favoritePlayerAlerts" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
        </form>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üé®</span> Display Preferences</h2>
        </div>
        <form>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="defaultStatsView">Default Stats View</label>
              <select id="defaultStatsView" class="form-select">
                <option value="season">Current Season</option>
                <option value="career">Career Stats</option>
                <option value="recent">Recent Games</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="defaultSeason">Default Season</label>
              <select id="defaultSeason" class="form-select">
                <option value="current">Current Season</option>
                <option value="2024-fall">2024 Fall</option>
                <option value="2024-summer">2024 Summer</option>
              </select>
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Preferences
            </button>
          </div>
        </form>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîê</span> Privacy</h2>
        </div>
        <form>
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Make my favorites visible to other users</span>
              <label class="toggle-switch">
                <input type="checkbox" id="publicFavorites">
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Privacy Settings
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Security Tab -->
    <div class="tab-content" id="tab-security">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîì</span> Account Security</h2>
        </div>
        <div id="successMessageSecurity" class="success-message">
          Password changed successfully!
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="accountEmail" disabled>
        </div>
        <div class="form-group">
          <label class="form-label">Account Type</label>
          <input type="text" class="form-input" id="accountType" value="Google Sign-In" disabled>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîë</span> Change Password</h2>
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          Since you're signed in with Google, password changes are managed through your Google account.
        </p>
        <a href="https://myaccount.google.com/security" target="_blank" class="btn btn-primary">
          Manage Google Account Security ‚Üí
        </a>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üö™</span> Sign Out</h2>
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          Sign out from your Mountainside Aces account on this device.
        </p>
        <button class="btn btn-secondary" id="signOutBtn">
          üö™ Sign Out
        </button>
      </div>
    </div>
  </main>

  <!-- Team Selection Modal -->
  <div class="modal" id="teamModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Favorite Team</h2>
        <button class="modal-close" onclick="closeTeamModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="teamSearch" placeholder="üîç Search teams...">
        <div class="selection-list" id="teamList">
          <!-- Teams will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTeamModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmTeamBtn" disabled onclick="confirmAddTeam()">
          <span>Add Team</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Player Selection Modal -->
  <div class="modal" id="playerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Favorite Player</h2>
        <button class="modal-close" onclick="closePlayerModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="playerSearch" placeholder="üîç Search players...">
        <div class="selection-list" id="playerList">
          <!-- Players will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePlayerModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmPlayerBtn" disabled onclick="confirmAddPlayer()">
          <span>Add Player</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { onAuthChange, getCurrentUser, logoutUser, getUserProfile, updateUserProfile as updateUserProfileAuth, addFavoriteTeam, addFavoritePlayer } from './firebase-auth.js';
    import { getCurrentSeason, getSeasonPlayerStatsOptimized, getAllTeams, getAllPlayerStatsOptimized } from './firebase-data.js';

    let currentUser = null;
    let userProfile = null;
    let selectedTeam = null;
    let selectedPlayer = null;
    let allTeams = [];
    let allPlayers = [];

    console.log('üîÑ Profile page loading...');

    // Tab switching functionality
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${targetTab}`).classList.add('active');
      });
    });

    // Initialize auth state
    onAuthChange(async (user) => {
      console.log('üîê Auth state changed:', user ? user.email : 'No user');
      
      if (user) {
        currentUser = user;
        try {
          await loadUserProfile(user);
          await loadUserStats(user);
        } catch (error) {
          console.error('‚ùå Error loading profile data:', error);
          alert('Error loading profile. Check console for details.');
        } finally {
          hideLoading();
        }
      } else {
        console.log('‚ö†Ô∏è No user signed in, redirecting to signin page...');
        window.location.href = 'signin.html';
      }
    });

    async function loadUserProfile(user) {
      console.log('üìã Loading user profile for:', user.uid);
      
      try {
        const result = await getUserProfile(user.uid);
        console.log('‚úÖ User profile result:', result);
        
        if (result.success && result.data) {
          userProfile = result.data;
        } else {
          console.log('‚ö†Ô∏è No profile data found');
          userProfile = null;
        }
        
        // If there's a mergedFromProfile, load that old profile data too
        let mergedProfileData = null;
        if (userProfile?.mergedFromProfile) {
          console.log('üîó Loading merged profile data from:', userProfile.mergedFromProfile);
          try {
            const { getPlayer } = await import('./firebase-data.js');
            mergedProfileData = await getPlayer(userProfile.mergedFromProfile);
            console.log('‚úÖ Merged profile data loaded:', mergedProfileData);
          } catch (error) {
            console.warn('‚ö†Ô∏è Could not load merged profile:', error);
          }
        }
        
        // NEW: Determine the display name to use (preferred or Google name)
        const displayName = userProfile?.preferredDisplayName || user.displayName || 'User';
        
        // Update header
        document.getElementById('profilePhoto').src = user.photoURL || 'https://via.placeholder.com/120';
        document.getElementById('displayName').textContent = displayName;
        document.getElementById('playerName').textContent = userProfile?.linkedPlayer || 'Not linked';
        document.getElementById('teamBadge').textContent = userProfile?.linkedTeam || 'No team';
        document.getElementById('accountEmail').value = user.email;
        
        // NEW: Load the display name form
        document.getElementById('preferredDisplayName').value = userProfile?.preferredDisplayName || '';
        document.getElementById('googleAccountName').textContent = user.displayName || user.email;
        
        // Calculate member since
        const createdDate = new Date(user.metadata.creationTime);
        document.getElementById('memberSince').textContent = `Member since ${createdDate.getFullYear()}`;
        
        // Load player info form - prefer merged profile data, fall back to current profile
        if (userProfile) {
          const nickname = userProfile.nickname || mergedProfileData?.nickname || '';
          const jerseyNumber = userProfile.number || mergedProfileData?.number || '';
          
          // Map single letter codes to full words
          const mapBattingCode = (code) => {
            if (!code) return '';
            const upper = code.toUpperCase();
            if (upper === 'R') return 'right';
            if (upper === 'L') return 'left';
            if (upper === 'S') return 'switch';
            return code.toLowerCase();
          };
          
          const mapThrowingCode = (code) => {
            if (!code) return '';
            const upper = code.toUpperCase();
            if (upper === 'R') return 'right';
            if (upper === 'L') return 'left';
            return code.toLowerCase();
          };
          
          const mapPosition = (pos) => {
            if (!pos) return '';
            const upper = pos.toUpperCase();
            if (upper === '1B') return '1b';
            if (upper === '2B') return '2b';
            if (upper === '3B') return '3b';
            if (upper === 'SS') return 'ss';
            if (upper === 'IF') return 'if';
            if (upper === 'LF') return 'lf';
            if (upper === 'CF') return 'cf';
            if (upper === 'RF') return 'rf';
            if (upper === 'OF') return 'of';
            if (upper === 'P') return 'pitcher';
            if (upper === 'C') return 'catcher';
            if (upper === 'UTILITY' || upper === 'UTL') return 'utility';
            return pos.toLowerCase();
          };
          
          const battingSide = mapBattingCode(userProfile.bats || mergedProfileData?.bats);
          const throwingArm = mapThrowingCode(userProfile.throws || mergedProfileData?.throws);
          const primaryPosition = mapPosition(userProfile.position || mergedProfileData?.position);
          const secondaryPositions = userProfile.secondaryPositions || '';
          
          document.getElementById('nickname').value = nickname;
          document.getElementById('jerseyNumber').value = jerseyNumber;
          document.getElementById('battingSide').value = battingSide;
          document.getElementById('throwingArm').value = throwingArm;
          document.getElementById('primaryPosition').value = primaryPosition;
          document.getElementById('secondaryPositions').value = secondaryPositions;
          
          console.log('üìù Loaded player info:', { nickname, jerseyNumber, battingSide, throwingArm, primaryPosition });
          
          // Load preferences
          document.getElementById('emailGameReminders').checked = userProfile.preferences?.emailGameReminders ?? true;
          document.getElementById('emailScoreUpdates').checked = userProfile.preferences?.emailScoreUpdates ?? false;
          document.getElementById('favoriteTeamNotifications').checked = userProfile.preferences?.favoriteTeamNotifications ?? true;
          document.getElementById('favoritePlayerAlerts').checked = userProfile.preferences?.favoritePlayerAlerts ?? true;
          document.getElementById('publicFavorites').checked = userProfile.preferences?.publicFavorites ?? false;
          
          // Update quick links
          if (userProfile.linkedPlayer) {
            document.getElementById('linkMyStats').href = `player.html?name=${encodeURIComponent(userProfile.linkedPlayer)}`;
          }
          if (userProfile.linkedTeam) {
            document.getElementById('linkMyTeam').href = `team.html?team=${encodeURIComponent(userProfile.linkedTeam)}`;
          }
          
          // Load favorites
          loadFavorites();
        }
      } catch (error) {
        console.error('‚ùå Error loading user profile:', error);
        // Continue anyway, show default values
        document.getElementById('profilePhoto').src = user.photoURL || 'https://via.placeholder.com/120';
        document.getElementById('displayName').textContent = user.displayName || 'User';
        document.getElementById('playerName').textContent = 'Not linked';
        document.getElementById('teamBadge').textContent = 'No team';
        document.getElementById('accountEmail').value = user.email;
      }
    }

    async function loadUserStats(user) {
      console.log('üìä Loading user stats...');
      
      try {
        if (!userProfile?.linkedPlayer) {
          console.log('‚ö†Ô∏è No linked player, skipping stats load');
          return;
        }
        
        const currentSeason = await getCurrentSeason();
        console.log('üìÖ Current season:', currentSeason ? currentSeason.id : 'No current season');
        
        if (!currentSeason) {
          console.log('‚ö†Ô∏è No current season found');
          return;
        }
        
        const stats = await getSeasonPlayerStatsOptimized(currentSeason.id);
        console.log('üìà Stats loaded:', stats.length, 'players');
        console.log('üîç Searching for player:', userProfile.linkedPlayer);
        console.log('üîó MergedFromProfile:', userProfile.mergedFromProfile);
        
        // Try multiple ways to find the player
        let playerStats = null;
        
        // First, try exact match on linkedPlayer name
        playerStats = stats.find(s => s.playerName === userProfile.linkedPlayer);
        
        if (!playerStats) {
          // Try matching by name field
          playerStats = stats.find(s => s.name === userProfile.linkedPlayer);
        }
        
        if (!playerStats) {
          // Try case-insensitive match
          const linkedPlayerLower = userProfile.linkedPlayer.toLowerCase();
          playerStats = stats.find(s =>
            s.playerName?.toLowerCase() === linkedPlayerLower ||
            s.name?.toLowerCase() === linkedPlayerLower
          );
        }
        
        // NEW: If still not found and we have a mergedFromProfile, try matching by ID
        if (!playerStats && userProfile.mergedFromProfile) {
          console.log('üîç Trying to find stats by merged profile ID:', userProfile.mergedFromProfile);
          playerStats = stats.find(s => s.id === userProfile.mergedFromProfile || s.playerId === userProfile.mergedFromProfile);
        }
        
        // NEW: If still not found, try to load directly from aggregatedPlayerStats using the user's current ID
        if (!playerStats) {
          console.log('üîç Trying to load stats directly using user ID:', user.uid);
          try {
            const { getPlayerStatsOptimized } = await import('./firebase-data.js');
            const directPlayerData = await getPlayerStatsOptimized(user.uid);
            if (directPlayerData) {
              console.log('‚úÖ Found player data directly:', directPlayerData);
              
              // Check if seasons object exists
              if (directPlayerData.seasons && typeof directPlayerData.seasons === 'object') {
                console.log('üì¶ Seasons object keys:', Object.keys(directPlayerData.seasons));
                
                // Find season keys that start with currentSeason.id (e.g., "2025-fall")
                const matchingKeys = Object.keys(directPlayerData.seasons).filter(key =>
                  key.startsWith(currentSeason.id)
                );
                
                console.log('üîç Matching season keys:', matchingKeys);
                
                if (matchingKeys.length > 0) {
                  // Use the first matching key
                  const seasonKey = matchingKeys[0];
                  const seasonStats = directPlayerData.seasons[seasonKey];
                  
                  if (seasonStats) {
                    playerStats = seasonStats;
                    console.log('‚úÖ Extracted season stats from key:', seasonKey, playerStats);
                  }
                }
              }
            }
          } catch (directLoadError) {
            console.warn('‚ö†Ô∏è Could not load stats directly:', directLoadError);
          }
        }
        
        if (playerStats) {
          console.log('‚úÖ Player stats found:', playerStats);
          document.getElementById('statGames').textContent = playerStats.games || 0;
          document.getElementById('statAvg').textContent = (playerStats.battingAverage || 0).toFixed(3);
          document.getElementById('statHits').textContent = playerStats.hits || 0;
          document.getElementById('statRuns').textContent = playerStats.runs || 0;
        } else {
          console.log('‚ö†Ô∏è No stats found for player:', userProfile.linkedPlayer);
          console.log('Available player names:', stats.slice(0, 10).map(s => ({
            name: s.playerName || s.name,
            id: s.id || s.playerId
          })));
          
          // Set defaults to show 0s instead of leaving blank
          document.getElementById('statGames').textContent = '0';
          document.getElementById('statAvg').textContent = '.000';
          document.getElementById('statHits').textContent = '0';
          document.getElementById('statRuns').textContent = '0';
        }
      } catch (error) {
        console.error('‚ùå Error loading user stats:', error);
        // Don't block page load for stats errors
        document.getElementById('statGames').textContent = '0';
        document.getElementById('statAvg').textContent = '.000';
        document.getElementById('statHits').textContent = '0';
        document.getElementById('statRuns').textContent = '0';
      }
    }

    function loadFavorites() {
      // Load favorite teams
      const favoriteTeams = userProfile?.favoriteTeams || [];
      const teamsGrid = document.getElementById('favoriteTeamsGrid');
      
      if (favoriteTeams.length === 0) {
        teamsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üèÜ</div>
            <div class="empty-state-text">No favorite teams yet</div>
            <p>Click "Add Team" to start tracking your favorites</p>
          </div>
        `;
      } else {
        teamsGrid.innerHTML = favoriteTeams.map(team => `
          <div class="favorite-card">
            <button class="remove-favorite" data-type="team" data-name="${team}">‚úñ</button>
            <div class="favorite-card-header">
              <div class="favorite-icon">üèÜ</div>
              <div class="favorite-card-title">${team}</div>
            </div>
            <div class="favorite-stats">
              <a href="team.html?team=${encodeURIComponent(team)}">View team page ‚Üí</a>
            </div>
          </div>
        `).join('');
      }
      
      // Load favorite players
      const favoritePlayers = userProfile?.favoritePlayers || [];
      const playersGrid = document.getElementById('favoritePlayersGrid');
      
      if (favoritePlayers.length === 0) {
        playersGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚≠ê</div>
            <div class="empty-state-text">No favorite players yet</div>
            <p>Click "Add Player" to start tracking up to 10 favorites</p>
          </div>
        `;
      } else {
        playersGrid.innerHTML = favoritePlayers.map(player => `
          <div class="favorite-card">
            <button class="remove-favorite" data-type="player" data-name="${player}">‚úñ</button>
            <div class="favorite-card-header">
              <div class="favorite-icon">‚≠ê</div>
              <div class="favorite-card-title">${player}</div>
            </div>
            <div class="favorite-stats">
              <a href="player.html?name=${encodeURIComponent(player)}">View player stats ‚Üí</a>
            </div>
          </div>
        `).join('');
      }
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-favorite').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const type = e.target.dataset.type;
          const name = e.target.dataset.name;
          removeFavorite(type, name);
        });
      });
    }

    // NEW: Handle display name form submission
    document.getElementById('displayNameForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const preferredDisplayName = document.getElementById('preferredDisplayName').value.trim();
      
      try {
        const updates = {
          preferredDisplayName: preferredDisplayName || null
        };
        
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // Update the local userProfile object
        userProfile.preferredDisplayName = preferredDisplayName || null;
        
        // Update the header display name immediately
        const displayName = preferredDisplayName || currentUser.displayName || 'User';
        document.getElementById('displayName').textContent = displayName;
        
        showSuccessMessage('successMessageDisplayName');
      } catch (error) {
        console.error('Error updating display name:', error);
        alert('Error saving display name. Please try again.');
      }
    });

    // NEW: Handle clear display name button
    document.getElementById('clearDisplayName').addEventListener('click', async () => {
      document.getElementById('preferredDisplayName').value = '';
      
      try {
        const updates = {
          preferredDisplayName: null
        };
        
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // Update the local userProfile object
        userProfile.preferredDisplayName = null;
        
        // Update the header display name immediately to Google name
        const displayName = currentUser.displayName || 'User';
        document.getElementById('displayName').textContent = displayName;
        
        showSuccessMessage('successMessageDisplayName');
      } catch (error) {
        console.error('Error clearing display name:', error);
        alert('Error clearing display name. Please try again.');
      }
    });

    // Form submissions
    document.getElementById('playerInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const mapToCode = (fullWord, type) => {
        if (!fullWord) return '';
        if (type === 'bats') {
          if (fullWord === 'right') return 'R';
          if (fullWord === 'left') return 'L';
          if (fullWord === 'switch') return 'S';
        }
        if (type === 'throws') {
          if (fullWord === 'right') return 'R';
          if (fullWord === 'left') return 'L';
        }
        if (type === 'position') {
          const posMap = {
            'pitcher': 'P', 'catcher': 'C', '1b': '1B', '2b': '2B',
            '3b': '3B', 'ss': 'SS', 'if': 'IF', 'lf': 'LF',
            'cf': 'CF', 'rf': 'RF', 'of': 'OF', 'utility': 'UTL'
          };
          return posMap[fullWord] || fullWord.toUpperCase();
        }
        return fullWord;
      };

      const updates = {
        nickname: document.getElementById('nickname').value,
        number: document.getElementById('jerseyNumber').value,
        bats: mapToCode(document.getElementById('battingSide').value, 'bats'),
        throws: mapToCode(document.getElementById('throwingArm').value, 'throws'),
        position: mapToCode(document.getElementById('primaryPosition').value, 'position'),
        secondaryPositions: document.getElementById('secondaryPositions').value
      };
      
      try {
        // Update the auth user profile
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // ALSO update the merged player profile if it exists
        if (userProfile?.mergedFromProfile) {
          console.log('üîÑ Also updating merged profile:', userProfile.mergedFromProfile);
          
          try {
            const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const { db } = await import('./firebase-data.js');
            
            const playerRef = doc(db, 'users', userProfile.mergedFromProfile);
            await updateDoc(playerRef, {
              ...updates,
              updatedAt: serverTimestamp()
            });
            
            console.log('‚úÖ Merged profile updated successfully');
          } catch (mergeError) {
            console.warn('‚ö†Ô∏è Could not update merged profile:', mergeError);
            // Don't fail the whole operation if merged profile update fails
          }
        }
        
        showSuccessMessage('successMessagePlayerInfo');
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error saving changes. Please try again.');
      }
    });

    document.getElementById('preferencesForm').addEventListener('change', async () => {
      const preferences = {
        emailGameReminders: document.getElementById('emailGameReminders').checked,
        emailScoreUpdates: document.getElementById('emailScoreUpdates').checked,
        favoriteTeamNotifications: document.getElementById('favoriteTeamNotifications').checked,
        favoritePlayerAlerts: document.getElementById('favoritePlayerAlerts').checked,
        publicFavorites: document.getElementById('publicFavorites').checked
      };
      
      try {
        const result = await updateUserProfileAuth(currentUser.uid, { preferences });
        if (result.success) {
          showSuccessMessage('successMessagePreferences');
        }
      } catch (error) {
        console.error('Error updating preferences:', error);
      }
    });

    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        const result = await logoutUser();
        if (result.success) {
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Error signing out:', error);
      }
    });

    // Add favorite buttons
    document.getElementById('addFavoriteTeam').addEventListener('click', async () => {
      await openTeamModal();
    });

    document.getElementById('addFavoritePlayer').addEventListener('click', async () => {
      const favoritePlayers = userProfile?.favoritePlayers || [];
      if (favoritePlayers.length >= 10) {
        alert('You can only have up to 10 favorite players. Remove some to add more.');
        return;
      }
      await openPlayerModal();
    });

    async function removeFavorite(type, name) {
      if (!confirm(`Remove ${name} from favorites?`)) return;
      
      try {
        const field = type === 'team' ? 'favoriteTeams' : 'favoritePlayers';
        const current = userProfile[field] || [];
        const updated = current.filter(item => item !== name);
        
        const result = await updateUserProfileAuth(currentUser.uid, { [field]: updated });
        if (result.success) {
          userProfile[field] = updated;
          loadFavorites();
        } else {
          throw new Error('Update failed');
        }
      } catch (error) {
        console.error('Error removing favorite:', error);
        alert('Error removing favorite. Please try again.');
      }
    }

    function showSuccessMessage(id) {
      const msg = document.getElementById(id);
      msg.classList.add('show');
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ========================================
    // TEAM SELECTION MODAL
    // ========================================

    async function openTeamModal() {
      console.log('üìã Opening team modal...');
      
      // Load teams if not already loaded
      if (allTeams.length === 0) {
        try {
          allTeams = await getAllTeams();
          console.log(`‚úÖ Loaded ${allTeams.length} teams`);
        } catch (error) {
          console.error('‚ùå Error loading teams:', error);
          alert('Error loading teams. Please try again.');
          return;
        }
      }

      // Render team list
      renderTeamList(allTeams);
      
      // Show modal
      document.getElementById('teamModal').classList.add('show');
      
      // Setup search
      const searchInput = document.getElementById('teamSearch');
      searchInput.value = '';
      searchInput.addEventListener('input', handleTeamSearch);
    }

    function renderTeamList(teams) {
      const list = document.getElementById('teamList');
      list.innerHTML = '';

      const favoriteTeams = userProfile?.favoriteTeams || [];
      
      // Sort teams alphabetically
      const sortedTeams = [...teams].sort((a, b) => 
        (a.name || a.id).localeCompare(b.name || b.id)
      );

      sortedTeams.forEach(team => {
        const teamName = team.name || team.id;
        const isAlreadyFavorite = favoriteTeams.includes(teamName);
        
        const item = document.createElement('div');
        item.className = 'selection-item';
        if (isAlreadyFavorite) {
          item.classList.add('disabled');
        }
        
        item.innerHTML = `
          <div class="selection-item-info">
            <div class="selection-item-name">${teamName}</div>
            <div class="selection-item-details">${team.description || 'Team'}</div>
          </div>
          ${isAlreadyFavorite ? '<span class="selection-item-badge">Already Added</span>' : ''}
        `;
        
        if (!isAlreadyFavorite) {
          item.addEventListener('click', () => selectTeam(item, teamName));
        }
        
        list.appendChild(item);
      });
    }

    function selectTeam(element, teamName) {
      // Remove previous selection
      document.querySelectorAll('#teamList .selection-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select this one
      element.classList.add('selected');
      selectedTeam = teamName;
      
      // Enable confirm button
      document.getElementById('confirmTeamBtn').disabled = false;
      
      console.log('Selected team:', teamName);
    }

    function handleTeamSearch(e) {
      const term = e.target.value.toLowerCase();
      
      document.querySelectorAll('#teamList .selection-item').forEach(item => {
        const name = item.querySelector('.selection-item-name').textContent.toLowerCase();
        if (name.includes(term)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    async function confirmAddTeam() {
      if (!selectedTeam || !currentUser) return;
      
      const confirmBtn = document.getElementById('confirmTeamBtn');
      const btnText = confirmBtn.querySelector('span');
      confirmBtn.disabled = true;
      btnText.textContent = 'Adding...';
      
      try {
        console.log('Adding team to favorites:', selectedTeam);
        
        const result = await addFavoriteTeam(currentUser.uid, selectedTeam);
        
        if (result.success) {
          console.log('‚úÖ Team added successfully!');
          // Update local profile
          if (!userProfile.favoriteTeams) userProfile.favoriteTeams = [];
          userProfile.favoriteTeams.push(selectedTeam);
          // Reload favorites display
          loadFavorites();
          // Close modal
          closeTeamModal();
        } else {
          throw new Error('Failed to add team');
        }
        
      } catch (error) {
        console.error('Error adding team:', error);
        alert('Error adding team. Please try again.');
        confirmBtn.disabled = false;
        btnText.textContent = 'Add Team';
      }
    }

    function closeTeamModal() {
      document.getElementById('teamModal').classList.remove('show');
      selectedTeam = null;
      document.getElementById('confirmTeamBtn').disabled = true;
    }

    // ========================================
    // PLAYER SELECTION MODAL
    // ========================================

    async function openPlayerModal() {
      console.log('üìã Opening player modal...');
      
      // Load players if not already loaded
      if (allPlayers.length === 0) {
        try {
          allPlayers = await getAllPlayerStatsOptimized();
          console.log(`‚úÖ Loaded ${allPlayers.length} players`);
        } catch (error) {
          console.error('‚ùå Error loading players:', error);
          alert('Error loading players. Please try again.');
          return;
        }
      }

      // Render player list
      renderPlayerList(allPlayers);
      
      // Show modal
      document.getElementById('playerModal').classList.add('show');
      
      // Setup search
      const searchInput = document.getElementById('playerSearch');
      searchInput.value = '';
      searchInput.addEventListener('input', handlePlayerSearch);
    }

    function renderPlayerList(players) {
      const list = document.getElementById('playerList');
      list.innerHTML = '';

      const favoritePlayers = userProfile?.favoritePlayers || [];
      
      // Sort players alphabetically
      const sortedPlayers = [...players].sort((a, b) => 
        (a.name || a.playerName || a.id).localeCompare(b.name || b.playerName || b.id)
      );

      sortedPlayers.forEach(player => {
        const playerName = player.name || player.playerName || player.id;
        const isAlreadyFavorite = favoritePlayers.includes(playerName);
        
        const careerGames = player.career?.games || 0;
        const careerBA = player.career?.battingAverage 
          ? player.career.battingAverage.toFixed(3) 
          : '0.000';
        const team = player.currentTeam || 'Unknown';
        
        const item = document.createElement('div');
        item.className = 'selection-item';
        if (isAlreadyFavorite) {
          item.classList.add('disabled');
        }
        
        item.innerHTML = `
          <div class="selection-item-info">
            <div class="selection-item-name">${playerName}</div>
            <div class="selection-item-details">${team} ‚Ä¢ ${careerGames} games ‚Ä¢ BA: ${careerBA}</div>
          </div>
          ${isAlreadyFavorite ? '<span class="selection-item-badge">Already Added</span>' : ''}
        `;
        
        if (!isAlreadyFavorite) {
          item.addEventListener('click', () => selectPlayer(item, playerName));
        }
        
        list.appendChild(item);
      });
    }

    function selectPlayer(element, playerName) {
      // Remove previous selection
      document.querySelectorAll('#playerList .selection-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select this one
      element.classList.add('selected');
      selectedPlayer = playerName;
      
      // Enable confirm button
      document.getElementById('confirmPlayerBtn').disabled = false;
      
      console.log('Selected player:', playerName);
    }

    function handlePlayerSearch(e) {
      const term = e.target.value.toLowerCase();
      
      document.querySelectorAll('#playerList .selection-item').forEach(item => {
        const name = item.querySelector('.selection-item-name').textContent.toLowerCase();
        const details = item.querySelector('.selection-item-details').textContent.toLowerCase();
        if (name.includes(term) || details.includes(term)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    async function confirmAddPlayer() {
      if (!selectedPlayer || !currentUser) return;
      
      const confirmBtn = document.getElementById('confirmPlayerBtn');
      const btnText = confirmBtn.querySelector('span');
      confirmBtn.disabled = true;
      btnText.textContent = 'Adding...';
      
      try {
        console.log('Adding player to favorites:', selectedPlayer);
        
        const result = await addFavoritePlayer(currentUser.uid, selectedPlayer);
        
        if (result.success) {
          console.log('‚úÖ Player added successfully!');
          // Update local profile
          if (!userProfile.favoritePlayers) userProfile.favoritePlayers = [];
          userProfile.favoritePlayers.push(selectedPlayer);
          // Reload favorites display
          loadFavorites();
          // Close modal
          closePlayerModal();
        } else {
          throw new Error('Failed to add player');
        }
        
      } catch (error) {
        console.error('Error adding player:', error);
        alert('Error adding player. Please try again.');
        confirmBtn.disabled = false;
        btnText.textContent = 'Add Player';
      }
    }

    function closePlayerModal() {
      document.getElementById('playerModal').classList.remove('show');
      selectedPlayer = null;
      document.getElementById('confirmPlayerBtn').disabled = true;
    }

    // Make functions available globally for onclick handlers
    window.closeTeamModal = closeTeamModal;
    window.confirmAddTeam = confirmAddTeam;
    window.closePlayerModal = closePlayerModal;
    window.confirmAddPlayer = confirmAddPlayer;
  </script>
</body>
</html>