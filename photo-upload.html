<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Photos - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --success-color: #48bb78;
  --error-color: #f56565;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

.page-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 2rem;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.softball-spinner::before {
  content: '📸';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Page Header */
.page-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 3rem 2rem;
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '📷';
  position: absolute;
  bottom: -30px;
  left: -30px;
  font-size: 200px;
  opacity: 0.08;
  transform: rotate(-15deg);
}

.page-header h1 {
  margin: 0;
  font-size: 2.5rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.page-header p {
  margin: 1rem 0 0 0;
  font-size: 1.1rem;
  opacity: 0.95;
  position: relative;
  z-index: 1;
}

/* Upload Card */
.upload-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  border: 2px solid var(--border-color);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.form-group select,
.form-group input[type="text"] {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  font-family: inherit;
  transition: border-color 0.3s ease;
}

.form-group select:focus,
.form-group input[type="text"]:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

/* Drag and Drop Area */
.drop-zone {
  border: 3px dashed var(--border-color);
  border-radius: 12px;
  padding: 3rem 2rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f7fafc;
  position: relative;
}

.drop-zone:hover {
  border-color: var(--primary-color);
  background: #edf2f7;
}

.drop-zone.drag-over {
  border-color: var(--secondary-color);
  background: #e6fffa;
  transform: scale(1.02);
}

.drop-zone-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.drop-zone-text {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.drop-zone-subtext {
  color: var(--text-light);
  font-size: 0.9rem;
}

#fileInput {
  display: none;
}

/* File Preview */
.file-preview-section {
  margin-top: 2rem;
  display: none;
}

.file-preview-section.visible {
  display: block;
}

.file-preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.file-preview-header h3 {
  margin: 0;
  color: var(--text-dark);
}

.clear-files-btn {
  padding: 0.5rem 1rem;
  background: var(--error-color);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.clear-files-btn:hover {
  background: #e53e3e;
  transform: translateY(-1px);
}

.file-list {
  display: grid;
  gap: 0.75rem;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: #f7fafc;
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.file-item.uploading {
  background: #e6fffa;
}

.file-item.success {
  background: #f0fff4;
  border-color: var(--success-color);
}

.file-item.error {
  background: #fff5f5;
  border-color: var(--error-color);
}

.file-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.file-info {
  flex: 1;
  min-width: 0;
}

.file-name {
  font-weight: 600;
  color: var(--text-dark);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-size {
  color: var(--text-light);
  font-size: 0.85rem;
}

.file-status {
  flex-shrink: 0;
  font-weight: 600;
  font-size: 0.85rem;
}

.file-status.pending {
  color: var(--text-light);
}

.file-status.uploading {
  color: var(--secondary-color);
}

.file-status.success {
  color: var(--success-color);
}

.file-status.error {
  color: var(--error-color);
}

.file-remove {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5rem;
  color: var(--text-light);
  transition: color 0.3s ease;
  padding: 0.25rem;
}

.file-remove:hover {
  color: var(--error-color);
}

/* Progress Bar */
.progress-container {
  margin-top: 2rem;
  display: none;
}

.progress-container.visible {
  display: block;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-dark);
}

.progress-bar-bg {
  height: 24px;
  background: #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  width: 0%;
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 0.85rem;
}

/* Upload Button */
.upload-btn {
  width: 100%;
  padding: 1rem 2rem;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 1.5rem;
  box-shadow: var(--shadow-md);
}

.upload-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.upload-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Success Message */
.success-message {
  background: #f0fff4;
  border: 2px solid var(--success-color);
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 2rem;
  display: none;
}

.success-message.visible {
  display: block;
}

.success-message h3 {
  color: var(--success-color);
  margin: 0 0 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.success-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.action-btn {
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
}

.action-btn-primary {
  background: var(--primary-color);
  color: white;
  border: none;
}

.action-btn-primary:hover {
  background: var(--secondary-color);
  transform: translateY(-1px);
}

.action-btn-secondary {
  background: white;
  color: var(--primary-color);
  border: 2px solid var(--primary-color);
}

.action-btn-secondary:hover {
  background: var(--primary-color);
  color: white;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .page-container {
    padding: 1rem;
  }

  .page-header {
    padding: 2rem 1rem;
  }

  .page-header h1 {
    font-size: 2rem;
  }

  .upload-card {
    padding: 1.5rem;
  }

  .drop-zone {
    padding: 2rem 1rem;
  }

  .success-actions {
    flex-direction: column;
  }

  .action-btn {
    width: 100%;
    text-align: center;
  }
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>

<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>📸 Upload Team Photos</h1>
    <p>Share your best Mountainside Aces moments with the league!</p>
  </div>

  <!-- Upload Card -->
  <div class="upload-card">
    <!-- Metadata Form -->
    <div class="form-group">
      <label for="folderSelect">Photo Category</label>
      <select id="folderSelect">
        <option value="league">League Photos (General)</option>
        <option value="green">Aces Green</option>
        <option value="blue">Aces Blue</option>
        <option value="orange">Aces Orange</option>
        <option value="purple">Aces Purple</option>
        <option value="red">Aces Red</option>
        <option value="yellow">Aces Yellow</option>
        <option value="black">Aces Black</option>
        <option value="white">Aces White</option>
        <option value="gold">Aces Gold</option>
      </select>
    </div>

    <div class="form-group">
      <label for="captionInput">Photo Caption (Optional)</label>
      <input type="text" id="captionInput" placeholder="e.g., Championship Game 2024, Team Photo, Playoff Action">
    </div>

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-icon">📷</div>
      <div class="drop-zone-text">Drag & Drop Photos Here</div>
      <div class="drop-zone-subtext">or click to browse (Max 50MB per file)</div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*,video/*">

    <!-- File Preview -->
    <div class="file-preview-section" id="filePreview">
      <div class="file-preview-header">
        <h3>Selected Files (<span id="fileCount">0</span>)</h3>
        <button class="clear-files-btn" id="clearFilesBtn">Clear All</button>
      </div>
      <div class="file-list" id="fileList"></div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-info">
        <span>Uploading...</span>
        <span id="progressText">0%</span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressBar">0%</div>
      </div>
    </div>

    <!-- Upload Button -->
    <button class="upload-btn" id="uploadBtn" disabled>
      Select Files to Upload
    </button>
  </div>

  <!-- Success Message -->
  <div class="success-message" id="successMessage">
    <h3>✅ Upload Successful!</h3>
    <p>Your photos have been uploaded and are now visible in the gallery.</p>
    <div class="success-actions">
      <a href="pictures.html" class="action-btn action-btn-primary">View Gallery</a>
      <button class="action-btn action-btn-secondary" onclick="resetUploadForm()">Upload More</button>
    </div>
  </div>
</div>

<script type="module">
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { app } from './firebase-data.js';
import { getUserProfile, hasPermission } from './firebase-auth.js';
import { uploadMultiplePhotos, formatFileSize } from './firebase-storage.js';

const auth = getAuth(app);
let selectedFiles = [];
let currentUser = null;

// DOM Elements
const loadingOverlay = document.getElementById('loadingOverlay');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const fileList = document.getElementById('fileList');
const fileCount = document.getElementById('fileCount');
const clearFilesBtn = document.getElementById('clearFilesBtn');
const uploadBtn = document.getElementById('uploadBtn');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const successMessage = document.getElementById('successMessage');
const folderSelect = document.getElementById('folderSelect');
const captionInput = document.getElementById('captionInput');

// Check authentication
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    console.log('✅ User authenticated:', user.email);
    
    // Check permissions
    try {
      console.log('🔄 Fetching user profile...');
      const profileResult = await getUserProfile(user.uid);
      
      if (!profileResult.success || !profileResult.data) {
        console.error('❌ getUserProfile failed:', profileResult);
        alert('Could not load user profile. Please try again.');
        window.location.href = 'profile.html';
        return;
      }
      
      const userProfile = profileResult.data;
      
      console.log('📋 User profile loaded:', {
        userType: userProfile.userType,
        userRole: userProfile.userRole,
        isCaptain: userProfile.isCaptain,
        isAdmin: userProfile.isAdmin,
        uid: user.uid
      });
      
      // Check multiple possible permission indicators
      const canUpload = 
        // Check userType field (new system)
        userProfile.userType === 'admin' ||
        userProfile.userType === 'captain' ||
        userProfile.userType === 'team-staff' ||
        // Check userRole field (legacy)
        userProfile.userRole === 'admin' ||
        userProfile.userRole === 'staff' ||
        // Check isCaptain flag
        userProfile.isCaptain === true ||
        // Check isAdmin flag
        userProfile.isAdmin === true ||
        // Check permissions
        hasPermission(userProfile, 'canManageStaff') || 
        hasPermission(userProfile, 'canEditRoster');
      
      console.log('🔒 Upload permission granted:', canUpload);
      
      if (!canUpload) {
        console.warn('⚠️ User does not have upload permissions');
        alert('You do not have permission to upload photos. This feature is for captains and admins only.');
        window.location.href = 'profile.html';
        return;
      }

      console.log('✅ Permission check passed, showing upload interface');
      loadingOverlay.classList.add('hidden');
      
    } catch (error) {
      console.error('❌ Error checking permissions:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      alert('Error verifying permissions: ' + error.message);
      window.location.href = 'profile.html';
    }
    
  } else {
    console.log('⚠️ No user authenticated, redirecting to signin');
    window.location.href = 'signin.html';
  }
});

// Drag and Drop Handlers
dropZone.addEventListener('click', () => {
  fileInput.click();
});

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  
  const files = Array.from(e.dataTransfer.files);
  handleFiles(files);
});

fileInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  handleFiles(files);
});

// Handle selected files
function handleFiles(files) {
  console.log('📁 Files selected:', files.length);
  
  // Filter valid files
  const validFiles = files.filter(file => {
    const isImage = file.type.startsWith('image/');
    const isVideo = file.type.startsWith('video/');
    const isValidSize = file.size <= 50 * 1024 * 1024; // 50MB
    
    if (!isImage && !isVideo) {
      alert(`${file.name} is not a valid image or video file.`);
      return false;
    }
    
    if (!isValidSize) {
      alert(`${file.name} exceeds the 50MB size limit.`);
      return false;
    }
    
    return true;
  });
  
  // Add to selected files
  selectedFiles = [...selectedFiles, ...validFiles];
  
  // Update UI
  updateFilePreview();
  updateUploadButton();
}

// Update file preview
function updateFilePreview() {
  fileList.innerHTML = '';
  fileCount.textContent = selectedFiles.length;
  
  if (selectedFiles.length > 0) {
    filePreview.classList.add('visible');
    
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.dataset.index = index;
      
      const icon = file.type.startsWith('video/') ? '🎥' : '📷';
      
      fileItem.innerHTML = `
        <div class="file-icon">${icon}</div>
        <div class="file-info">
          <div class="file-name">${file.name}</div>
          <div class="file-size">${formatFileSize(file.size)}</div>
        </div>
        <div class="file-status pending">Ready</div>
        <button class="file-remove" onclick="removeFile(${index})">✕</button>
      `;
      
      fileList.appendChild(fileItem);
    });
  } else {
    filePreview.classList.remove('visible');
  }
}

// Remove file
window.removeFile = function(index) {
  selectedFiles.splice(index, 1);
  updateFilePreview();
  updateUploadButton();
};

// Clear all files
clearFilesBtn.addEventListener('click', () => {
  selectedFiles = [];
  fileInput.value = '';
  updateFilePreview();
  updateUploadButton();
});

// Update upload button state
function updateUploadButton() {
  if (selectedFiles.length > 0) {
    uploadBtn.disabled = false;
    uploadBtn.textContent = `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
  } else {
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Select Files to Upload';
  }
}

// Upload files
uploadBtn.addEventListener('click', async () => {
  if (selectedFiles.length === 0) return;
  
  // Disable button
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'Uploading...';
  
  // Show progress
  progressContainer.classList.add('visible');
  
  // Gather metadata
  const folder = folderSelect.value;
  const caption = captionInput.value || 'Team Photo';
  const teamId = folderSelect.value !== 'league' ? folderSelect.value : null;
  
  console.log('🚀 Starting upload:', { folder, caption, teamId, fileCount: selectedFiles.length });
  
  try {
    // Upload files - note: uploadMultiplePhotos doesn't support progress callback
    // We'll update progress after each file
    const results = await uploadMultiplePhotos(selectedFiles, folder, caption, teamId);
    
    console.log('✅ Upload complete:', results);
    
    // Update UI based on results
    const successCount = results.successful.length;
    const failCount = results.failed.length;
    
    // Update file statuses
    selectedFiles.forEach((file, index) => {
      const fileItem = document.querySelector(`[data-index="${index}"]`);
      if (fileItem) {
        const statusEl = fileItem.querySelector('.file-status');
        const wasSuccessful = results.successful.find(r => r.fileName === file.name);
        const wasFailed = results.failed.find(r => r.fileName === file.name);
        
        if (wasSuccessful) {
          fileItem.classList.add('success');
          statusEl.textContent = '✅ Uploaded';
          statusEl.className = 'file-status success';
        } else if (wasFailed) {
          fileItem.classList.add('error');
          statusEl.textContent = '❌ Failed';
          statusEl.className = 'file-status error';
        }
      }
    });
    
    // Update progress bar to 100%
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    progressText.textContent = `${successCount}/${selectedFiles.length} files uploaded`;
    
    if (successCount > 0) {
      // Show success message
      successMessage.classList.add('visible');
      
      if (failCount > 0) {
        successMessage.querySelector('p').textContent = 
          `${successCount} file${successCount > 1 ? 's' : ''} uploaded successfully. ${failCount} failed.`;
      }
    } else {
      alert('All uploads failed. Please check your internet connection and try again.');
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Retry Upload';
    }
    
  } catch (error) {
    console.error('❌ Upload error:', error);
    alert('Upload failed: ' + error.message);
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'Retry Upload';
  }
});

// Reset form
window.resetUploadForm = function() {
  selectedFiles = [];
  fileInput.value = '';
  captionInput.value = '';
  updateFilePreview();
  updateUploadButton();
  progressContainer.classList.remove('visible');
  successMessage.classList.remove('visible');
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';
  progressText.textContent = '0%';
};
</script>

<script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
<script src="mobile-enhancements.js"></script>

</body>
</html>
